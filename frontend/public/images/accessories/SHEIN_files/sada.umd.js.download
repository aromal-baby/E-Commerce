var _excluded=["$primaryKey","$retryCount"],_excluded2=["environment","server_type"],_excluded3=["server","env"],_excluded4=["trace"],_excluded5=["clks","exps"];function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,u=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){u=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(u)throw i}}}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,i,a,u=[],s=!0,c=!1;try{if(i=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;s=!1}else for(;!(s=(n=i.call(r)).done)&&(u.push(n.value),u.length!==t);s=!0);}catch(l){c=!0,o=l}finally{try{if(!s&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(c)throw o}}return u}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _objectWithoutProperties(e,t){if(null==e)return{};var r,n,o=_objectWithoutPropertiesLoose(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],-1===t.indexOf(r)&&{}.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var r={};for(var n in e)if({}.hasOwnProperty.call(e,n)){if(-1!==t.indexOf(n))continue;r[n]=e[n]}return r}function _regenerator(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */
var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function i(r,n,o,i){var s=n&&n.prototype instanceof u?n:u,c=Object.create(s.prototype);return _regeneratorDefine2(c,"_invoke",function(r,n,o){var i,u,s,c=0,l=o||[],d=!1,f={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,r){return i=t,u=0,s=e,f.n=r,a}};function p(r,n){for(u=r,s=n,t=0;!d&&c&&!o&&t<l.length;t++){var o,i=l[t],p=f.p,h=i[2];r>3?(o=h===n)&&(s=i[(u=i[4])?5:(u=3,3)],i[4]=i[5]=e):i[0]<=p&&((o=r<2&&p<i[1])?(u=0,f.v=n,f.n=i[1]):p<h&&(o=r<3||i[0]>n||n>h)&&(i[4]=r,i[5]=n,f.n=h,u=0))}if(o||r>1)return a;throw d=!0,n}return function(o,l,h){if(c>1)throw TypeError("Generator is already running");for(d&&1===l&&p(l,h),u=l,s=h;(t=u<2?e:s)||!d;){i||(u?u<3?(u>1&&(f.n=-1),p(u,s)):f.n=s:f.v=s);try{if(c=2,i){if(u||(o="next"),t=i[o]){if(!(t=t.call(i,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,u<2&&(u=0)}else 1===u&&(t=i.return)&&t.call(i),u<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),u=1);i=e}else if((t=(d=f.n<0)?s:r.call(n,f))!==a)break}catch(v){i=e,u=1,s=v}finally{c=1}}return{value:t,done:d}}}(r,o,i),!0),c}var a={};function u(){}function s(){}function c(){}t=Object.getPrototypeOf;var l=[][n]?t(t([][n]())):(_regeneratorDefine2(t={},n,(function(){return this})),t),d=c.prototype=u.prototype=Object.create(l);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,_regeneratorDefine2(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return s.prototype=c,_regeneratorDefine2(d,"constructor",c),_regeneratorDefine2(c,"constructor",s),s.displayName="GeneratorFunction",_regeneratorDefine2(c,o,"GeneratorFunction"),_regeneratorDefine2(d),_regeneratorDefine2(d,o,"Generator"),_regeneratorDefine2(d,n,(function(){return this})),_regeneratorDefine2(d,"toString",(function(){return"[object Generator]"})),(_regenerator=function(){return{w:i,m:f}})()}function _regeneratorDefine2(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(i){o=0}(_regeneratorDefine2=function(e,t,r,n){function i(t,r){_regeneratorDefine2(e,t,(function(e){return this._invoke(t,r,e)}))}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(i("next",0),i("throw",1),i("return",2))})(e,t,r,n)}function asyncGeneratorStep(e,t,r,n,o,i,a){try{var u=e[i](a),s=u.value}catch(c){return void r(c)}u.done?t(s):Promise.resolve(s).then(n,o)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var i=e.apply(t,r);function a(e){asyncGeneratorStep(i,n,o,a,u,"next",e)}function u(e){asyncGeneratorStep(i,n,o,a,u,"throw",e)}a(void 0)}))}}function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach((function(t){_defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e,t=function(e){var t=e.key,r=e.value,n=e.expire;try{var o={value:r,expire:void 0!==n?(new Date).getTime()+n:void 0};localStorage.setItem(t,JSON.stringify(o))}catch(i){console.error("set localStorage error: "+(null==i?void 0:i.message))}},r=function(e){try{var t=localStorage.getItem(e);if(!t)return null;var r=JSON.parse(t),n=r.value,o=r.expire;return void 0!==o&&(new Date).getTime()>o?(localStorage.removeItem(e),null):n}catch(i){return console.error("getLocalStorage error: "+(null==i?void 0:i.message)),null}},n=function(e,t){if(t<e[0]||t>e[e.length-1])return-1;for(var r=0,n=e.length-1;r<=n;){var o=Math.floor((r+n)/2);if(e[o]===t)return o;e[o]>t?n=o-1:r=o+1}return-1},o=function(){return _createClass((function e(n){var o=this;_classCallCheck(this,e),_defineProperty(this,"DB_NAME",""),_defineProperty(this,"SHELL_PRIMARY_KEY",{}),this.DB_NAME=n.DB_NAME||"";var i=n.SHELL_LIST||[""];Object.keys(n.SHELL_CONFIG||{}).forEach((function(e){var t,r=(null===(t=n.SHELL_CONFIG)||void 0===t?void 0:t[e])||{};r.keyPath&&(o.SHELL_PRIMARY_KEY[e]=r.keyPath)})),i.forEach((function(e){var n=o.DB_NAME+"_"+e;r(n)||t({key:n,value:{index:-1},expire:6048e5})}))}),[{key:"get",value:function(e,t){for(var n=this.DB_NAME+"_"+e,o=r(n),i=Object.keys(o).filter((function(e){return!isNaN(Number(e))})),a=[],u=0;u<t&&!(i.length<=0);u++){var s=i.shift(),c=o[s||""];c&&a.push({data:c,primaryKey:s})}return a}},{key:"getRange",value:function(e,t,o){var i=this.DB_NAME+"_"+e,a=r(i),u=Object.keys(a).filter((function(e){return!isNaN(Number(e))})).map(Number),s=n(u,t),c=n(u,o);if(-1==s&&-1==c)return[];s=-1===s?0:s,c=-1===c?u.length-1:c;for(var l=[],d=s;d<=c;d++){var f=a[u[d]];f&&l.push(f)}return l}},{key:"add",value:function(e,n){var o,i=this.DB_NAME+"_"+e,a=this.SHELL_PRIMARY_KEY[e];if(a){if("object"!==_typeof(n))return;if(!n[a])return}var u=r(i),s=a?n[a]:(null!==(o=null==u?void 0:u.index)&&void 0!==o?o:-1)+1,c=s<0?0:s;u[c]=n,t({key:i,value:_objectSpread(_objectSpread({},u),{},{index:c}),expire:2592e5})}},{key:"update",value:function(e,t,n){var o=this.DB_NAME+"_"+e;r(o)[t]=n}},{key:"delete",value:function(e,n){if("number"==typeof n){var o=this.DB_NAME+"_"+e,i=r(o);delete i[n],t({key:o,value:_objectSpread({},i),expire:6048e5})}}}])}(),i=function(){return _createClass((function e(){_classCallCheck(this,e),_defineProperty(this,"DB_NAME",""),_defineProperty(this,"SHELL_LIST",[]),_defineProperty(this,"backupDB",null),_defineProperty(this,"DB_UN_SUPPORT",!1),_defineProperty(this,"db",void 0)}),[{key:"initDBName",value:function(e){this.DB_NAME=e.DB_NAME||this.DB_NAME,this.SHELL_LIST=e.SHELL_LIST||this.SHELL_LIST}},{key:"globalDB",value:function(){return"undefined"==typeof window?null:window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB}},{key:"creteBackupDB",value:function(e){this.DB_UN_SUPPORT=!0,this.backupDB=new o(e)}},{key:"init",value:function(e){var t=this;return new Promise((function(r,n){try{if(t.initDBName(e),!t.DB_NAME||!t.SHELL_LIST.length)return n("DB_NAME or SHELL_LIST is required");var o=t.globalDB();if(!o)return t.creteBackupDB(e),r(!0);var i=o.open(t.DB_NAME,e.VERSION||1);i.addEventListener("error",(function(e){n(e)})),i.addEventListener("success",(function(e){t.db=e.target.result,r(e.target.result),t.db.addEventListener("versionchange",(function(){t.db.close(),location.reload()}))})),i.addEventListener("upgradeneeded",(function(r){t.db=r.target.result,t.SHELL_LIST.forEach((function(r){var n;t.db.objectStoreNames.contains(r)||t.db.createObjectStore(r,_objectSpread({autoIncrement:!0},null===(n=e.SHELL_CONFIG)||void 0===n?void 0:n[r]))}))}))}catch(a){n(a)}}))}},{key:"get",value:(n=_asyncToGenerator(_regenerator().m((function e(t,r){var n=this;return _regenerator().w((function(e){for(;;)if(0===e.n)return e.a(2,new Promise((function(e,o){var i,a=[];if(r<=0)return e(a);if(n.DB_UN_SUPPORT)return e((null===(i=n.backupDB)||void 0===i?void 0:i.get(t,r))||[]);var u=n.db.transaction([t],"readonly").objectStore(t).openCursor(null,"prev");u.addEventListener("success",(function(t){var n=t.target.result;if(n&&a.length<r){var o=n.value;a.push({data:o,primaryKey:n.primaryKey}),n.continue()}else e(a)})),u.addEventListener("error",(function(e){o(e)}))})))}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"getRange",value:(r=_asyncToGenerator(_regenerator().m((function e(t,r,n){var o=this;return _regenerator().w((function(e){for(;;)if(0===e.n)return e.a(2,new Promise((function(e,i){var a;if(o.DB_UN_SUPPORT)return e((null===(a=o.backupDB)||void 0===a?void 0:a.getRange(t,r,n))||[]);var u=o.db.transaction([t],"readonly").objectStore(t).getAll(IDBKeyRange.bound(r,n));u.addEventListener("success",(function(t){var r=t.target.result;e(r)})),u.addEventListener("error",(function(e){i(e)}))})))}),e)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"update",value:function(e,t,r){var n=this;return new Promise((function(o,i){try{var a;if(n.DB_UN_SUPPORT)return null===(a=n.backupDB)||void 0===a||a.update(e,t,r),o(!0);var u=n.db.transaction([e],"readwrite").objectStore(e),s=u.get(t);s.addEventListener("success",(function(){var e=u.put(r,t);e.addEventListener("success",(function(e){o(e)})),e.addEventListener("error",(function(e){i(e)}))})),s.addEventListener("error",(function(e){i(e)}))}catch(c){i(c)}}))}},{key:"add",value:(t=_asyncToGenerator(_regenerator().m((function e(t,r){var n=this;return _regenerator().w((function(e){for(;;)if(0===e.n)return e.a(2,new Promise((function(e,o){try{var i;if(n.DB_UN_SUPPORT)return null===(i=n.backupDB)||void 0===i||i.add(t,r),e(!0);var a=n.db.transaction([t],"readwrite").objectStore(t).add(r);a.addEventListener("success",(function(t){e(t.target.result)})),a.addEventListener("error",(function(e){o(e)}))}catch(u){o(u)}})))}),e)}))),function(e,r){return t.apply(this,arguments)})},{key:"delete",value:(e=_asyncToGenerator(_regenerator().m((function e(t,r){var n=this;return _regenerator().w((function(e){for(;;)if(0===e.n)return e.a(2,new Promise((function(e,o){try{var i;if(n.DB_UN_SUPPORT)return null===(i=n.backupDB)||void 0===i||i.delete(t,r),e(!0);var a=n.db.transaction([t],"readwrite").objectStore(t).delete(r);a.addEventListener("success",(function(t){e(t)})),a.addEventListener("error",(function(e){o(e)}))}catch(u){o(u)}})))}),e)}))),function(t,r){return e.apply(this,arguments)})}]);var e,t,r,n}(),a="sada-fetch_id",u=function(){return _createClass((function e(t,r){_classCallCheck(this,e),_defineProperty(this,"isAvailable",!0),_defineProperty(this,"dbIsReady",!1),_defineProperty(this,"num",20),_defineProperty(this,"loopTime",2e3),_defineProperty(this,"retryCount",1/0),_defineProperty(this,"waitToAddQueue",[]),_defineProperty(this,"waitToConsume",!1),_defineProperty(this,"_DB_",void 0),_defineProperty(this,"_timer_",null),_defineProperty(this,"consumehttp",void 0),_defineProperty(this,"consumeSort",void 0),_defineProperty(this,"dbConfig",{name:"sada-store",shellName:"sada"}),_defineProperty(this,"onReady",void 0),_defineProperty(this,"onRecord",void 0),_defineProperty(this,"onDelete",void 0),this.num=(null==r?void 0:r.consume_count)||this.num,this.loopTime="number"==typeof(null==r?void 0:r.loop_time)?null==r?void 0:r.loop_time:this.loopTime,this.retryCount="number"==typeof(null==r?void 0:r.retry_count)?null==r?void 0:r.retry_count:this.retryCount,this.loopTime<=0&&(this.loopTime=0),this.loopTime>6e4&&(this.loopTime=6e4),this.loopTime<1e3&&(this.isAvailable=!1),this.retryCount<=0&&(this.retryCount=1),null!=r&&r.loop_time&&this.loopTime!=(null==r?void 0:r.loop_time)&&console.warn("[@shein-aidc/sada] loop_time is not in the range of 0ms to 1min"),this.consumehttp=t.httpRequest,this.consumeSort=t.sort||function(e){return[e]},this.onReady=(null==r?void 0:r.onReady)||function(){},this.onRecord=(null==r?void 0:r.onRecord)||function(){},this.onDelete=(null==r?void 0:r.onDelete)||function(){},this.initDb()}),[{key:"initDb",value:function(){var e=this;this._DB_=new i,this._DB_.init({DB_NAME:this.dbConfig.name,SHELL_LIST:[this.dbConfig.shellName]}).then((function(){for(e.onReady&&e.onReady(!0),e.dbIsReady=!0;e.waitToAddQueue.length;){var t=e.waitToAddQueue.shift();t&&e.record(t)}e.waitToConsume&&e.consume()})).catch((function(t){console.log("初始化失败",t),e.dbIsReady=!1,e.onReady&&e.onReady(!1)}))}},{key:"startLoop",value:function(){var e=this;this.isAvailable?this._timer_||(this.loopTime>0?this._timer_=setInterval((function(){e.consume()}),this.loopTime):this.consume()):console.warn("[@shein-aidc/sada] store loopCheck is not available, please check the loop_time configuration.")}},{key:"stopLoop",value:function(){this._timer_&&(clearInterval(this._timer_),this._timer_=null)}},{key:"consumeHandle",value:function(e,n){var o=this;if(!e||!e.length)return this.stopLoop();var i,u=r(a)||[],s=e.filter((function(e){return Number(e.data.$retryCount||0)<o.retryCount&&-1===u.indexOf(e.primaryKey)})),c=function(e){e.forEach((function(e){var t=e.$primaryKey,r=e.$retryCount,i=_objectWithoutProperties(e,_excluded);if(r&&r>=o.retryCount)o.delete({primaryKey:t});else{var a=_objectSpread(_objectSpread({},i),{},{$retryCount:(r||0)+1});o.updata(t,a).then((function(){n&&o.consumeHandle([{primaryKey:t,data:a}],!0)}))}}))};void 0!==this.consumehttp&&(null===(i=this.consumeSort)||void 0===i||i.call(this,s.map((function(e){return _objectSpread({$primaryKey:e.primaryKey},e.data)})).filter((function(e){return!!e.$primaryKey}))).forEach((function(e){if(0!==e.length){var n=e.map((function(e){return e.$primaryKey}));t({key:a,value:u.concat(n),expire:1e4}),o.consumehttp(e).then((function(t){t?e.forEach((function(e){o.delete({primaryKey:e.$primaryKey})})):c(e)})).catch((function(){c(e)})).finally((function(){var e=(r(a)||[]).filter((function(e){return!n.includes(e)}));t({key:a,value:e,expire:1e4})}))}})))}},{key:"consume",value:function(){var e;this.dbIsReady?null===(e=this._DB_)||void 0===e||null===(e=e.get(this.dbConfig.shellName,this.num))||void 0===e||null===(e=e.then(this.consumeHandle.bind(this)))||void 0===e||e.catch((function(e){console.log("消费失败",e)})):this.waitToConsume=!0}},{key:"record",value:function(e,t){var r=this;return this.dbIsReady?new Promise((function(n,o){var i;if(!r._DB_)return o(new Error("DB is not ready"));null===(i=r._DB_)||void 0===i||null===(i=i.add(r.dbConfig.shellName,e))||void 0===i||null===(i=i.then((function(o){t&&"number"==typeof o?r.consumeHandle([{primaryKey:o,data:e}],!0):r.startLoop(),r.onRecord&&r.onRecord(!0,{data:e,primaryKey:o}),n(o)})))||void 0===i||i.catch((function(t){console.log("添加失败",t),r.onRecord&&r.onRecord(!1,{data:e,primaryKey:-1}),o(t)}))})):(this.waitToAddQueue.push(e),Promise.reject(!1))}},{key:"delete",value:function(e){var t=this;return this.dbIsReady&&void 0!==e?new Promise((function(r,n){var o;(null===(o=t._DB_)||void 0===o?void 0:o.delete(t.dbConfig.shellName,e.primaryKey).then((function(){t.onDelete&&t.onDelete(!0,{primaryKey:e.primaryKey}),r(!0)})).catch((function(){t.onDelete&&t.onDelete(!1,{primaryKey:e.primaryKey}),n(!1)})))||n(!1)})):Promise.reject(!1)}},{key:"updata",value:function(e,t){var r;return(null===(r=this._DB_)||void 0===r?void 0:r.update(this.dbConfig.shellName,e,t))||Promise.reject(!1)}}])}(),s=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"usa",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"production",r="";switch(e){case"eur":var n={production:"https://data.srmdata-eur.com",gray:"https://www.srmdata-gray.com",localhost:"https://www.srmdata-gray.com",debug:"https://www.srmdata-gray.com"};r=n[t];break;case"usa":var o={production:"https://data.srmdata-us.com",gray:"https://www.srmdata-gray.com",localhost:"https://www.srmdata-gray.com",debug:"https://www.srmdata-gray.com"};r=o[t];break;default:var i={production:"https://data.srmdata.com",gray:"https://www.srmdata-gray.com",localhost:"https://www.srmdata-gray.com",debug:"https://www.srmdata-gray.com"};r=i[t]}return r},c=function(e){var t={};return e.split("|").forEach((function(e){var r=_slicedToArray(e.split(":"),2),n=r[0],o=r[1];n&&o&&(t[n]=o)})),t},l=function(e){if(!e)return"";try{return JSON.parse(e)}catch(t){return{}}},d=function(){return _createClass((function e(){_classCallCheck(this,e)}),[{key:"http",value:function(e){e.data||(e.data=e.params||{}),this.fetch(e)}},{key:"fetch",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){if("function"==typeof fetch){if(!e.url)return console.log("[client-http] fetch url is required");var t=e.method||"GET";e.method||(t=e.data?"POST":"GET");var r=e.headers||{};try{"function"==typeof e.beforeRequest&&e.beforeRequest({url:e.url,method:t,headers:r,data:e.data})}catch(u){console.log("[client-http] beforeRequest error: ",u)}var n=new AbortController,o={method:t,headers:r,signal:n.signal};"POST"===t&&(o.body=JSON.stringify(e.data)),"GET"===t&&(e.url=e.url+"?"+this.formatParams(e.data));var i=null,a=new Promise((function(t,r){i=setTimeout((function(){var e=new Error("Request timed out");throw r(e),n.abort(),e}),e.timeout||1e4)}));Promise.race([fetch(e.url,o),a]).then((function(e){return e.status>=200&&e.status<300||304==e.status?e.text():Promise.reject(e)})).then((function(t){var r;null===(r=e.success)||void 0===r||r.call(e,l(t))})).catch((function(t){var r;null===(r=e.error)||void 0===r||r.call(e,t)})).finally((function(){i&&(clearTimeout(i),i=null)}))}else this.ajax(e)}))},{key:"ajax",value:function(e){if(!e.url)return console.log("[client-http] fetch url is required");var t=this.xhr();if(!t)return!1;var r=e.method||"GET";e.method||(r=e.data?"POST":"GET"),"GET"===r&&(e.url=e.url+"?"+this.formatParams(e.data)),t.open(r,e.url,!0),t.timeout=e.timeout||1e4,(e.success||e.error)&&(t.onreadystatechange=function(){try{if(4==t.readyState){var r,n;if(t.status>=200&&t.status<300||304==t.status)null===(r=e.success)||void 0===r||r.call(e,l(t.responseText));else null===(n=e.error)||void 0===n||n.call(e,l(t.responseText));t.onreadystatechange=null,t.onload=null}}catch(o){t.onreadystatechange=null,t.onload=null}},t.ontimeout=function(){var r,n=new Error("Request timed out");throw null===(r=e.error)||void 0===r||r.call(e,n),t.abort(),n});var n=e.headers;try{"function"==typeof e.beforeRequest&&e.beforeRequest({url:e.url,method:r,headers:n,data:e.data})}catch(a){console.log("[client-http] beforeRequest error: ",a)}for(var o in n){var i=n[o];i&&t.setRequestHeader(o,i)}t.send(JSON.stringify(e.data))}},{key:"xhr",value:function(){return"undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:null}},{key:"formatParams",value:function(e){var t=[];for(var r in e||{}){var n=e[r];void 0!==n&&t.push("".concat(r,"=").concat(encodeURIComponent(n)))}return t.join("&")}}])}(),f="undefined"!=typeof window?new d:void 0,p={data:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.page_name,r=e.page_id,n=e.activity_name,o=e.activity_param,i=e.timestamp,a=e.user_id,u=e.$init,s=void 0===u?{}:u,c=o||{},l=c.trace,d=_objectWithoutProperties(c,_excluded4),f=(null==o?void 0:o.goods_id)||"";return{sub_site:s.site_uid||"",timestamp:i,page_name:t,page_id:r,activity_name:n,activity_param:_objectSpread({goods_id:"",ad_data:"",ad_id:f?"".concat(a,"_").concat(l||"unset","_").concat(f):""},d)}},traceValidation:function(e,t){return!(!e.activity_name||!e.activity_name.endsWith("_adad"))||(!t&&console.warn('[@shein-aidc/sada] activity_name is required and must end with "_adad"'),!1)},validation:function(e,t){return["activity_name","activity_param","page_name","page_id","sub_site"].every((function(r){if(!e[r])return!t&&console.warn("[@shein-aidc/sada] ".concat(r," is required")),!1;if("activity_param"===r){if("object"!==_typeof(e[r]))return!t&&console.warn("[@shein-aidc/sada] ".concat(r," must be an object")),!1;return["ad_id","goods_id","ad_data"].every((function(n){return!!e[r][n]||(!t&&console.warn("[@shein-aidc/sada] ".concat(r,".").concat(n," is required")),!1)}))}return!0}))}},h=function(e){return e.replace(/\\u([\dA-Fa-f]{4})/g,(function(e,t){return String.fromCharCode(parseInt(t,16))}))},v="\\u0063\\u006F\\u006F\\u006B\\u0069\\u0065\\u005F\\u0069\\u0064";h("\\u0063\\u006F\\u006F\\u006B\\u0069\\u0064\\u0049\\u0064"),h(v);var y=function(){return _createClass((function e(){_classCallCheck(this,e)}),[{key:"autoTrack",value:(e=_asyncToGenerator(_regenerator().m((function e(){var t,r,n,o,i,a,u,s,c,l,d,f,p,h,v,y,m=arguments;return _regenerator().w((function(e){for(;;)switch(e.p=e.n){case 0:if(t=m.length>0&&void 0!==m[0]?m[0]:{},r=m.length>1?m[1]:void 0,e.p=1,n=window.localStorage.getItem("autoTrack")){e.n=2;break}return e.a(2);case 2:if(o=JSON.parse(n),i=window.localStorage.getItem("autoReportTepNum")||0,window.localStorage.setItem("autoReportTepNum",String(Number(i)+1)),a=window.gbCommonInfo&&window.gbCommonInfo.langPath||"",u=a?a.startsWith("/")?a:"/".concat(a):a,s=window.gbCommonInfo&&window.gbCommonInfo.origin_site||[location.protocol,"//",location.host,u].join(""),c=[s,"/shein-tep"].join(""),l="".concat(c,"/tep-detect-tob/event/upload"),Array.isArray(t)||(t.referer_expect=encodeURIComponent(window.location.href)),d={cases:o.cases,session:o.tokenId,group_list:o.groupList,raw:t},!(r&&r.beacon&&navigator&&"function"==typeof navigator.sendBeacon)){e.n=3;break}return p=(f=o||{}).cases,h=f.tokenId,v=new FormData,h&&v.append("session",h),p&&p.length&&p.forEach((function(e){v.append("cases",e)})),v.append("group_list",JSON.stringify(o.groupList)),v.append("raw",JSON.stringify(t)),e.a(2,navigator.sendBeacon(l+"/form",v));case 3:fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}),e.n=5;break;case 4:e.p=4,y=e.v,console.error(y);case 5:return e.a(2)}}),e,null,[[1,4]])}))),function(){return e.apply(this,arguments)})},{key:"pipeEtp",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,r="\\u0068\\u0074\\u0074\\u0070\\u0073\\u003A\\u002F\\u002F\\u0062\\u0075\\u0072\\u0069\\u0065\\u0064\\u002D\\u0061\\u0064\\u006D\\u0069\\u006E\\u002D\\u0061\\u0070\\u0069\\u002D\\u0067\\u0072\\u0061\\u0079\\u0030\\u0033\\u002E\\u0062\\u0069\\u007A\\u002E\\u0073\\u0068\\u0065\\u0069\\u006E\\u0063\\u006F\\u0072\\u0070\\u002E\\u0063\\u006E\\u002F\\u0073\\u0068\\u0065\\u0069\\u006E\\u002F\\u0061\\u006E\\u0061\\u006C\\u0079\\u007A\\u0065",n=h(r);if(null!=t&&t.beacon&&navigator&&"function"==typeof navigator.sendBeacon){var o=new Blob([JSON.stringify(e)],{type:"application/json; charset=UTF-8"});return navigator.sendBeacon(n,o)}fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}}]);var e}(),m=new y,_=function(){return _createClass((function e(){_classCallCheck(this,e),_defineProperty(this,"store",void 0),_defineProperty(this,"innerFieldInfo",{$requestPublicFields:[["appversion","app_version"],"device_type","user_id","armortoken","armoruuid"],$device:{},$options:{},$init:{},$complexInit:{}}),_defineProperty(this,"dynamicParams",{}),_defineProperty(this,"models",{}),_defineProperty(this,"defaultModelName","SHEIN_AD_EVENT"),"undefined"!=typeof window&&(this.bindEvent(),this.browserInfo()),this.registerModel(this.defaultModelName,p)}),[{key:"https",value:function(e){var t,r=this,n=_objectSpread({},null===(t=this.innerFieldInfo.$complexInit.request)||void 0===t?void 0:t.headers);return new Promise((function(t,o){var i,a,u,l=Date.now();(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((function(r,n){var o=[],i=[],a="";e.data.forEach((function(e){a=a||e.$groupId;var t={};for(var r in e)r.startsWith("$")||(t[r]=e[r]);t.activity_name&&(t.activity_name.startsWith("click_")&&i.push(t),t.activity_name.startsWith("expose_")&&o.push(t))}));var u=c(a),l=u.server,d=u.env,p=_objectWithoutProperties(u,_excluded3),h=e.url||"".concat(s(l,d),"/data/msg"),v=_objectSpread({"Content-Type":"application/json"},e.headers),y={data:_objectSpread(_objectSpread({send_ts:Date.now()},p),{},{exps:o,clks:i})},m=function(e){r({res:e,data:y.data})};if(!i.length&&!o.length)return console.warn("[@shein-aidc/sada] No exposure or click data to report."),m(!0);try{var _;null==t||null===(_=t.onRequest)||void 0===_||_.call(t,y.data)}catch(b){console.log("[@shein-aidc/sada] hooks onRequest error",b)}null==f||f.http({url:h,method:e.method||"POST",timeout:e.timeout,headers:v,data:y,success:m,error:function(e){n({res:e,data:y.data})}})}))})({url:(null===(i=r.innerFieldInfo.$complexInit)||void 0===i||null===(i=i.request)||void 0===i?void 0:i.url)||"",method:(null===(a=r.innerFieldInfo.$complexInit)||void 0===a||null===(a=a.request)||void 0===a?void 0:a.method)||"POST",timeout:null===(u=r.innerFieldInfo.$complexInit)||void 0===u||null===(u=u.request)||void 0===u?void 0:u.timeout,headers:n,data:e},{onRequest:function(e){try{var t,n;if(null===(t=r.innerFieldInfo.$complexInit)||void 0===t||null===(t=t.hooks)||void 0===t||null===(n=t.onRequest)||void 0===n||n.call(t,e),window.localStorage.getItem("autoTrack")){var o=JSON.parse(JSON.stringify(e)),i=o.clks,a=void 0===i?[]:i,u=o.exps,s=void 0===u?[]:u,c=_objectWithoutProperties(o,_excluded5),l=[].concat(_toConsumableArray(a),_toConsumableArray(s)).map((function(e){return _objectSpread(_objectSpread({},e),c)}));m.autoTrack(l)}}catch(d){console.log("[@shein-aidc/sada] hooks onRequest error",d)}}}).then((function(e){var n=e.res,o=0===(null==n?void 0:n.code)||!0===n;try{var i,a;null===(i=r.innerFieldInfo.$complexInit)||void 0===i||null===(i=i.hooks)||void 0===i||null===(a=i.onResponse)||void 0===a||a.call(i,o?200:n.status,{res:n,data:e.data,dur:Date.now()-l})}catch(u){console.log("[@shein-aidc/sada] hooks onResponse error",u)}t(o)})).catch((function(e){try{var t,n;null===(t=r.innerFieldInfo.$complexInit)||void 0===t||null===(t=t.hooks)||void 0===t||null===(n=t.onResponse)||void 0===n||n.call(t,400,{res:e,dur:Date.now()-l})}catch(i){console.log("[@shein-aidc/sada] hooks onResponse error",i)}o(e)}))}))}},{key:"creteStore",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var t;this.store=new u({sort:function(e){var t={};return e.forEach((function(e){var r=e.$groupId;t[r]||(t[r]=[]),t[r].push(e)})),Object.values(t)},httpRequest:this.https.bind(this)},e),null===(t=this.store)||void 0===t||t.consume()}catch(r){console.log("[@shein-aidc/sada] Store 初始化失败",r)}}},{key:"bindEvent",value:function(){var e=this;window.addEventListener("beforeunload",(function(){var t;null===(t=e.store)||void 0===t||t.consume()})),"hidden"in document&&document.addEventListener("visibilitychange",(function(){var t;document.hidden&&(null===(t=e.store)||void 0===t||t.consume())}))}},{key:"browserInfo",value:function(){}},{key:"generatePublicFileds",value:function(e){if(!this.innerFieldInfo.$requestPublicFields.length)return{};var t,r={},n=_createForOfIteratorHelper(this.innerFieldInfo.$requestPublicFields);try{for(n.s();!(t=n.n()).done;){var o=t.value,i="",a="";"string"==typeof o?a=i=o:(i=o[0]||"",a=o[1]||"");var u=e[i];u&&"string"==typeof u&&(r[a]=u)}}catch(s){n.e(s)}finally{n.f()}return r}},{key:"reduceFields",value:function(e){var t=_objectSpread(_objectSpread({},this.innerFieldInfo.$options),{},{$init:_objectSpread({},this.innerFieldInfo.$init)});if(Object.keys(this.dynamicParams).length>0)for(var r in this.dynamicParams)try{t[r]=this.dynamicParams[r]()}catch(s){console.info("[@shein-aidc/sada] dynamic params ".concat(r),s)}for(var n in e){var o,i,a=e[n];if("object"===_typeof(a))if("object"===_typeof(null===(o=this.innerFieldInfo.$options)||void 0===o?void 0:o[n])||"object"===_typeof(t[n]))t[n]=_objectSpread(_objectSpread(_objectSpread({},null===(i=this.innerFieldInfo.$options)||void 0===i?void 0:i[n]),t[n]),a);else t[n]=a;else t[n]=a||t[n]}var u=_objectSpread({$groupId:""},t);return{publicFields:this.generatePublicFileds(_objectSpread(_objectSpread({},t.$init),u)),bodyFileds:u}}},{key:"init",value:function(e){var t,r;for(var n in e){var o=e[n];this.innerFieldInfo["string"==typeof o?"$init":"$complexInit"][n]=o}this.creteStore(_objectSpread(_objectSpread({},null==e?void 0:e.cache),{},{retry_count:null==e||null===(t=e.request)||void 0===t?void 0:t.retry_count})),this.innerFieldInfo.$requestPublicFields=[].concat(_toConsumableArray((null==e||null===(r=e.request)||void 0===r?void 0:r.public_fields)||[]),_toConsumableArray(this.innerFieldInfo.$requestPublicFields))}},{key:"registerFields",value:function(e){var t={};for(var r in e)try{var n=e[r];"function"==typeof n?this.dynamicParams[r]=n:t[r]=JSON.parse(JSON.stringify(n))}catch(o){console.info("[@shein-aidc/sada] registerFields ".concat(r),o)}this.innerFieldInfo.$options=_objectSpread(_objectSpread({},this.innerFieldInfo.$options),t)}},{key:"registerField",value:function(e,t){"string"==typeof e&&e?"function"==typeof t?this.dynamicParams[e]=t:this.innerFieldInfo.$options[e]=t:console.warn("[@shein-aidc/sada] registerField fieldName should be a non-empty string")}},{key:"registerModel",value:function(e,t,r){return"string"==typeof e&&e?"object"!==_typeof(t)?console.warn("[@shein-aidc/sada] registerModel model should be an object"):(this.models[e]&&console.warn("[@shein-aidc/sada] registerModel model ".concat(e," already exists, will be overwritten")),this.models[e]=t,void(null!=r&&r.asDefault&&(this.defaultModelName=e))):console.warn("[@shein-aidc/sada] registerModel modelName should be a non-empty string")}},{key:"traceModel",value:function(e,t,r){var n,o=this;if("string"!=typeof e||!e)return console.warn("[@shein-aidc/sada] traceModel modelName should be a non-empty string");var i=this.models[e],a="production"===(this.innerFieldInfo.$init.environment||"production");if(!i)return console.warn("[@shein-aidc/sada] traceModel model ".concat(e," not found"));if("function"!=typeof i.traceValidation||i.traceValidation(t,a)){var u,s=this.reduceFields(_objectSpread(_objectSpread({},t),{},{timestamp:Date.now()})),c=s.bodyFileds,l=s.publicFields;if("function"==typeof i.data)try{u=i.data(c)}catch(v){console.warn("[@shein-aidc/sada] traceModel model ".concat(e," data method error"),v),u=c}else u=_objectSpread(_objectSpread({},i.data),c);if(u){for(var d in u.$groupId=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.environment,r=e.server_type,n=_objectWithoutProperties(e,_excluded2),o=[];return Object.keys(n).forEach((function(e){void 0!==n[e]&&null!==n[e]&&o.push("".concat(e,":").concat(n[e]))})),["env:".concat(t||"production"),"server:".concat(r||"central")].concat(o).join("|")}(_objectSpread(_objectSpread({},l),{},{environment:this.innerFieldInfo.$init.environment,server_type:this.innerFieldInfo.$init.server_type})),l)void 0!==u[d]&&delete u[d];if("function"==typeof i.validation){var f={};if(Object.keys(u).forEach((function(e){e.startsWith("$")||e.startsWith("_")||(f[e]=u[e])})),!i.validation(f,a))return}if(null!=r&&r.immediate||null===(n=this.store)||void 0===n||!n.isAvailable){var p=function(e,t){var r=function(){var r,n;o.store?null===(r=o.store)||void 0===r||r.record(_objectSpread(_objectSpread({},e),{},{$retryCount:1})):t<((null===(n=o.store)||void 0===n?void 0:n.retryCount)||1/0)&&p(e,t+1)};o.https([e]).then((function(e){e||r()})).catch(r.bind(o))};p(u,0)}else{var h;null===(h=this.store)||void 0===h||h.record(u)}}}}},{key:"trace",value:function(e,t){this.traceModel(this.defaultModelName,e,t)}},{key:"get",value:function(e){switch(e){case"model":return this.models;case"device":return this.innerFieldInfo.$device}}}])}(),b=window.sada,g=new _;if(null!==(e=window.sada)&&void 0!==e&&e._private_load&&console.log("%c 🔥🔥🔥 [@shein-aidc/sada] 埋点重复引入，请检查当前页面资源的引入 \n","border-radius: 3px; background:yellow;color:black;font-size:14px"),void 0!==b&&b._q&&b._q.length){var w=b._q;w&&w.length&&w.forEach((function(e){var t=e[0],r=e[1];"function"==typeof g[t]&&g[t].apply(g,_toConsumableArray(r))}))}window.sada=g,window.sada._private_load=!0}));
