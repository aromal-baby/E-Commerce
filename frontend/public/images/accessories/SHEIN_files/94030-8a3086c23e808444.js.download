(self.webpackChunkSHEIN_W=self.webpackChunkSHEIN_W||[]).push([[94030],{12393:e=>{var t="undefined"!=typeof crypto&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&msCrypto.getRandomValues.bind(msCrypto);if(t){var i=new Uint8Array(16);e.exports=function(){return t(i),i}}else{var o=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)3&t||(e=4294967296*Math.random()),o[t]=e>>>((3&t)<<3)&255;return o}}},53555:(e,t,i)=>{"use strict";i.d(t,{$:()=>O});var o=i(274061),n=i(518295),r=i(461739),a=i(665640);function s(e,t,i,o,n,r,a){try{var s=e[r](a),u=s.value}catch(e){return void i(e)}s.done?t(u):Promise.resolve(u).then(o,n)}function u(e){return function(){var t=this,i=arguments;return new Promise((function(o,n){var r=e.apply(t,i);function a(e){s(r,o,n,a,u,"next",e)}function u(e){s(r,o,n,a,u,"throw",e)}a(void 0)}))}}function l(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,o)}return i}function c(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?l(Object(i),!0).forEach((function(t){h(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):l(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function h(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var o=i.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var g={DIALOG_REGISTERED:"dialog:registered",REGISTRATION_COMPLETE:"registration:complete",DIALOG_INITIALIZED:"dialog:initialized",DIALOG_SKIPPED:"dialog:skipped",QUEUE_UPDATED:"queue:updated",QUEUE_STARTED:"queue:started",QUEUE_ADVANCED:"queue:advanced",QUEUE_EMPTY:"queue:empty",PRIORITY_CHANGED:"priority:changed",RENDER_AUTO_MOUNT:"render:autoMount",RENDER_STANDARD:"render:standard",DIALOG_BEFORE_SHOW:"dialog:beforeShow",DIALOG_SHOWN:"dialog:shown",DIALOG_HIDE:"dialog:hide",DIALOG_HIDDEN:"dialog:hidden",DIALOG_ERROR:"dialog:error",DIALOG_PRELOAD_START:"dialog:preload:start",DIALOG_PRELOAD_COMPLETE:"dialog:preload:complete",DIALOG_FREQUENCY_LIMITED:"dialog:frequencyLimited",CONDITIONS_CHECKED:"conditionsChecked",BFF_FILTER_APPLIED:"bff:filterApplied",BFF_FILTER_ERROR:"bff:filterError"},d={REGISTERED:!1,WAITING:!1,SHOWING:!1,CLOSED:!1,SKIPPED:!1,ERROR:!1,REASON:"",_PREPARING:!1,_RENDERING:!1,_PREPARED:!1,_BFF_CHECKED:!1,_BFF_DETAILS:{}},p="global",f={name:"",priority:100,region:p,type:"function",keepAlive:!1,watchRouter:!1,exclude:[],condition:()=>!0,onBeforeQueue:()=>{},onBeforeShow:()=>{},onAfterShow:()=>{},displayOptions:{timeout:0,inViewport:!1,delay:0,renderCheckTimeout:0},waitForCondition:5e3,frequencyControl:{enabled:!1,storage:"localStorage",key:"",maxCount:1,interval:0,expiry:0,resetOnVersionChange:!1},props:{},_compatMode:!1,_renderType:"standard",_status:d};var m=new class{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};h(this,"options",void 0),h(this,"colors",void 0),this.options=c({level:0,prefix:"[PopupSDK]",enabled:!1,useColors:!0},e),this.colors={debug:"#7f8c8d",info:"#3498db",warn:"#f39c12",error:"#e74c3c"}}_getTimeString(){return(new Date).toTimeString().split(" ")[0]}_format(e,t){return"".concat(this.options.prefix," [").concat(this._getTimeString(),"] [").concat(e.toUpperCase(),"] ").concat(t)}debug(e){if(this.options.enabled){for(var t=this._format("debug",e),i=arguments.length,o=new Array(i>1?i-1:0),n=1;n<i;n++)o[n-1]=arguments[n];this.options.useColors?a.debug("%c".concat(t),"color: ".concat(this.colors.debug),...o):a.debug(t,...o)}}info(e){if(this.options.enabled){for(var t=this._format("info",e),i=arguments.length,o=new Array(i>1?i-1:0),n=1;n<i;n++)o[n-1]=arguments[n];this.options.useColors?a.info("%c".concat(t),"color: ".concat(this.colors.info),...o):a.info(t,...o)}}warn(e){if(this.options.enabled){for(var t=this._format("warn",e),i=arguments.length,o=new Array(i>1?i-1:0),n=1;n<i;n++)o[n-1]=arguments[n];this.options.useColors?a.warn("%c".concat(t),"color: ".concat(this.colors.warn),...o):a.warn(t,...o)}}error(e){if(this.options.enabled){for(var t=this._format("error",e),i=arguments.length,o=new Array(i>1?i-1:0),n=1;n<i;n++)o[n-1]=arguments[n];this.options.useColors?a.error("%c".concat(t),"color: ".concat(this.colors.error),...o):a.error(t,...o)}}setLevel(e){return this.options.level=e,this}setEnabled(e){return this.options.enabled=e,this}setPrefix(e){return this.options.prefix=e,this}setUseColors(e){return this.options.useColors=e,this}},v=!1;try{v=!!sessionStorage.getItem("popup_sdk_debug"),a.log("debugEnabled: ",v)}catch(e){}m.setEnabled(v);class D{constructor(e,t,i){h(this,"eventBus",void 0),h(this,"queue",void 0),h(this,"dialogs",void 0),h(this,"globalContext",void 0),h(this,"_pendingDialogs",new Set),h(this,"_pendingRegionDialogs",new Map),this.eventBus=e,this.queue=t,this.dialogs=new Map,this.globalContext=i,this.eventBus.on(g.REGISTRATION_COMPLETE,(()=>{m.info("[DialogCenter]: Registration complete, processing all pending dialogs"),this._processAllPendingDialogs()})),this.eventBus.on(g.DIALOG_SHOWN,(e=>{var{name:t}=e;this._recordDialogShow(t)})),this.eventBus.on(g.DIALOG_SKIPPED,(e=>{var{name:t,reason:i}=e;m.info('[DialogCenter]: Dialog "'.concat(t,'" skipped'));var o=this.dialogs.get(t);o&&(o._status.SKIPPED=!0,o._status.REASON=i||"promise rejected or timeout")})),this.eventBus.on(g.DIALOG_REGISTERED,(e=>{var{name:t}=e;m.info('[DialogCenter]: Dialog "'.concat(t,'" registered'));var i=this.dialogs.get(t);i&&(i._status.REGISTERED=!0)})),this.eventBus.on(g.DIALOG_FREQUENCY_LIMITED,(e=>{var{name:t}=e;m.info('[DialogCenter]: Dialog "'.concat(t,'" frequency limited'));var i=this.dialogs.get(t);i&&(i._status.REASON="FREQUENCY_LIMITED")}))}register(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.dialogs.has(e))return a.warn('[DialogCenter]: Dialog "'.concat(e,'" already registered, returning existing dialog')),this.dialogs.get(e);null!=i&&i._compatMode||"autoMount"!==(null==i?void 0:i._renderType)||("function"!=typeof t?a.error('Component for "'.concat(e,'" must be a function when using autoMount render type')):i.importFn=t);var o=c(c(c({},f),i),{},{name:e,component:t,displayOptions:c(c({},f.displayOptions),i.displayOptions||{}),frequencyControl:c(c({},f.frequencyControl),i.frequencyControl||{}),_status:c({},f._status)});return o.frequencyControl.enabled&&!o.frequencyControl.key&&(o.frequencyControl.key="popup_frequency_".concat(e)),this.dialogs.set(e,o),this.eventBus.emit(g.DIALOG_REGISTERED,{name:e,options:o}),null!=o&&o._compatMode?this._promiseWithTimeout(Promise.resolve(o.condition()),null==o?void 0:o.waitForCondition).then((t=>{this._checkConditionResult(t,e)&&"function"==typeof o.importFn&&o.importFn().then((()=>{m.info('[DialogCenter]: compat Dialog "'.concat(e,'" imported successfully'))})).catch((t=>{m.error('[DialogCenter]: Error importing compat dialog "'.concat(e,'":'),t)}))})):this._addToPendingJudgment(e),o}registerAutoMount(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return"function"!=typeof t?(a.error('Import function for "'.concat(e,'" must be a function')),null):this.register(e,null,c(c({},i),{},{importFn:t,_compatMode:!0,_renderType:"autoMount"}))}_addToPendingJudgment(e){this._pendingDialogs.add(e),m.info('[DialogCenter]: Dialog "'.concat(e,'" added to pending judgment list'))}_processAllPendingDialogs(){try{if(0===this._pendingDialogs.size)return m.info("[DialogCenter]: No pending dialogs to process"),void this.eventBus.emit(g.CONDITIONS_CHECKED,{isTimedout:!1});m.info("[DialogCenter]: Processing ".concat(this._pendingDialogs.size," pending dialogs"));var e=Array.from(this._pendingDialogs).map((e=>this.dialogs.get(e))).filter(Boolean).sort(((e,t)=>e.priority-t.priority));this._pendingDialogs.clear();var t=e.map((e=>this._processDialogCondition(e.name)));Promise.all(t).then((()=>{m.info("[DialogCenter]: All dialog conditions processed"),this.eventBus.emit(g.CONDITIONS_CHECKED,{isTimedout:!1})})).catch((e=>{m.error("[DialogCenter]: Error processing dialog conditions",e),this.eventBus.emit(g.CONDITIONS_CHECKED,{isTimedout:!1})}))}catch(e){m.error("[DialogCenter]: Unexpected error during dialog processing",e),this.eventBus.emit(g.CONDITIONS_CHECKED,{isTimedout:!1})}}_processDialogCondition(e){var t=this;return u((function*(){var i=t.dialogs.get(e);if(i&&!i._compatMode){var o=t._pendingRegionDialogs.get(i.region);if(i.region===p||o&&o.names.includes(e)){if(o&&o.props&&(i.props=c(c({},i.props),o.props)),!t._checkFrequencyControl(e))return m.info('[DialogCenter]: Dialog "'.concat(e,'" skipped due to frequency control')),void t.eventBus.emit(g.DIALOG_FREQUENCY_LIMITED,{name:e,frequencyInfo:t.getFrequencyInfo(e)});try{var n=yield t._promiseWithTimeout(Promise.resolve(i.condition(i,t.globalContext)),null==i?void 0:i.waitForCondition);if(!t._checkConditionResult(n,e))return;i.onBeforeQueue(i),t.queue.add(i),t.eventBus.emit(g.DIALOG_INITIALIZED,{name:e})}catch(i){m.error('[DialogCenter]: Error checking condition for dialog "'.concat(e,'":'),i),t.eventBus.emit(g.DIALOG_ERROR,{name:e,error:i,errorMsg:"执行条件检查时发生错误"})}}else t.eventBus.emit(g.DIALOG_SKIPPED,{name:e,reason:"弹窗不在默认区域，需要手动调用"})}}))()}setPriority(e,t){return this.dialogs.has(e)?(this.dialogs.get(e).priority=t,this.eventBus.emit(g.PRIORITY_CHANGED,{name:e,priority:t}),!0):(a.error('Cannot set priority: Dialog "'.concat(e,'" not found')),!1)}getFrequencyInfo(e){var t=this.dialogs.get(e);if(!t||!t.frequencyControl.enabled)return null;var{frequencyControl:i}=t,o="sessionStorage"===i.storage?sessionStorage:localStorage,n=i.key;try{var r=o.getItem(n);return r?JSON.parse(r):{count:0,lastShown:0}}catch(t){return m.error('Failed to get frequency info for "'.concat(e,'":'),t),{count:0,lastShown:0}}}resetFrequency(e){var t=this.dialogs.get(e);if(!t||!t.frequencyControl.enabled)return!1;var{frequencyControl:i}=t,o="sessionStorage"===i.storage?sessionStorage:localStorage,n=i.key;try{return o.removeItem(n),!0}catch(t){return m.error('Failed to reset frequency for "'.concat(e,'":'),t),!1}}_checkFrequencyControl(e){var t=this.dialogs.get(e);if(!t||!t.frequencyControl.enabled)return!0;var{frequencyControl:i}=t,o=this.getFrequencyInfo(e);if(!o)return!0;var n=Date.now();if(i.maxCount>0&&o.count>=i.maxCount)return m.debug('[DialogCenter]:Dialog "'.concat(e,'" reached max frequency count (').concat(o.count,"/").concat(i.maxCount,")")),!1;if(i.interval>0&&o.lastShown>0){var r=n-o.lastShown;if(r<i.interval)return m.debug('[DialogCenter]: Dialog "'.concat(e,'" interval not reached (').concat(r,"ms < ").concat(i.interval,"ms)")),!1}if(i.expiry>0&&o.lastShown>0&&n-o.lastShown>i.expiry)return this.resetFrequency(e),!0;return!0}_recordDialogShow(e){var t=this.dialogs.get(e);if(t&&t.frequencyControl.enabled){var{frequencyControl:i}=t,o="sessionStorage"===i.storage?sessionStorage:localStorage,n=i.key;try{var r=this.getFrequencyInfo(e)||{count:0,lastShown:0};r={count:r.count+1,lastShown:Date.now(),version:i.resetOnVersionChange?t._version:void 0},o.setItem(n,JSON.stringify(r)),m.debug('[DialogCenter]: Dialog "'.concat(e,'" show recorded (count: ').concat(r.count,")"))}catch(t){m.error('[DialogCenter]: Failed to record dialog show for "'.concat(e,'":'),t)}}}_promiseWithTimeout(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{value:!1,reason:"timeout"},o=new Promise((e=>{var o=setTimeout((()=>{clearTimeout(o),m.warn("Promise timed out after ".concat(t,"ms, returning fallback value:"),i),e(i)}),t)}));return Promise.race([e.catch((e=>({value:!1,reason:"error",error:e.message||"Unknown error"}))),o])}_checkConditionResult(e,t){var i,o,n=(null===(i=this.queue.currentDialog)||void 0===i?void 0:i.name)===t,r=this.queue.queue.findIndex((e=>e.name===t)),a=-1!==r,s=(null===(o=this.queue.nextDialog)||void 0===o?void 0:o.name)===t,u=!0,l="";if("object"==typeof e&&null!==e&&"value"in e?null!=e&&e.value||(u=!1,l=(null==e?void 0:e.reason)||"condition_not_met_object"):e||(u=!1,l="condition_not_met_boolean"),!u){if(m.info('[DialogCenter]: Dialog "'.concat(t,'" condition failed, reason: ').concat(l)),n)m.info('[DialogCenter]: Hiding currently showing dialog "'.concat(t,'" due to failed condition recheck.')),this.queue.hide(t,l);else if(s){m.info('[DialogCenter]: Clearing prepared dialog (nextDialog) "'.concat(t,'" due to failed condition recheck.'));var c=this.queue.nextDialog;c&&(c._status.SKIPPED=!0,c._status.REASON=l,c._status._PREPARED=!1),this.queue.nextDialog=null}else if(a){m.info('[DialogCenter]: Removing dialog "'.concat(t,'" from queue array due to failed condition recheck.'));var h=this.queue.queue[r];h&&(h._status.SKIPPED=!0,h._status.REASON=l),this.queue.queue.splice(r,1)}return this.eventBus.emit(g.DIALOG_SKIPPED,{name:t,reason:l}),!1}return m.info('[DialogCenter]: Dialog "'.concat(t,'" condition passed.')),!0}getDialog(e){return e?this.dialogs.get(e):this.dialogs}addDialogsToQueneByRegion(e,t,i){if(!e)return[];var o=Array.from(this.dialogs.values()).filter((t=>t.region===e));if(!o.length)return this._pendingRegionDialogs.set(e,{names:t,props:i}),[];var n=o.filter((e=>!t||0===t.length||!!t.includes(e.name)));return n.length?(this._pendingRegionDialogs.set(e,{names:n.map((e=>e.name)),props:i}),n.forEach((e=>{this._addToPendingJudgment(e.name)})),this._pendingDialogs.size>0&&this._processAllPendingDialogs(),n):[]}recheckConditions(e){e&&0!==e.length&&(e.forEach((e=>{this.dialogs.has(e)&&this._addToPendingJudgment(e)})),this._pendingDialogs.size>0&&this._processAllPendingDialogs())}exists(e){return this.dialogs.has(e)}getAllDialogs(e){if(e&&!this.dialogs.has(e))return a.error('Dialog "'.concat(e,'" not found')),[];var t=Array.from(this.dialogs.values()).map((e=>({name:e.name,_status:e._status})));return e?t.filter((t=>t.name===e)):t}}class _{constructor(e){h(this,"eventBus",void 0),h(this,"currentDialog",void 0),h(this,"nextDialog",null),h(this,"isStarted",void 0),h(this,"isProcessing",void 0),h(this,"isPreparing",!1),h(this,"queue",void 0),h(this,"dialogCenter",void 0),h(this,"waitingTimeoutId",void 0),h(this,"waitDelay",void 0),h(this,"hasEverStarted",!1),h(this,"startType","single"),h(this,"_beforeShowFilter",null),h(this,"_processingDialog",null),this.eventBus=e,this.queue=[],this.currentDialog=null,this.nextDialog=null,this.isStarted=!1,this.isProcessing=!1,this.isPreparing=!1,this.dialogCenter=null,this.waitingTimeoutId=null,this.waitDelay=1e3,this._processingDialog=null,this._setupEventListeners()}_setupEventListeners(){this.eventBus.on(g.PRIORITY_CHANGED,(()=>{this._sortQueue(),!this.currentDialog||this.nextDialog||this.isPreparing||setTimeout((()=>this._prepareNext()),10)})),this.eventBus.on(g.DIALOG_HIDDEN,(e=>{var{reason:t}=e;m.info("[DialogQueue]","Dialog hidden due to: ".concat(t))})),this.eventBus.on(g.QUEUE_EMPTY,(()=>{m.info("[DialogQueue]","Queue is empty, waiting for new dialogs")})),this.eventBus.on(g.QUEUE_UPDATED,(e=>{var{queue:t}=e;m.info("[DialogQueue]","Queue updated: ".concat(t.join(", ")))})),this.eventBus.on(g.QUEUE_STARTED,(()=>{m.info("[DialogQueue]","Queue started")})),this.eventBus.on(g.DIALOG_SHOWN,(e=>{var t,{name:i}=e;m.info("[DialogQueue]",'Dialog "'.concat(i,'" is shown'));var o=null===(t=this.dialogCenter)||void 0===t?void 0:t.dialogs.get(i);o&&(o._status.SHOWING=!0)})),this.eventBus.on(g.DIALOG_ERROR,(e=>{var t,{name:i,error:o}=e;m.error("[DialogQueue]",'Error in dialog "'.concat(i,'":'),o);var n=null===(t=this.dialogCenter)||void 0===t?void 0:t.dialogs.get(i);n&&(n._status.ERROR=!0,n._status.SKIPPED=!0,n._status.REASON=o.message||"Unknown error")})),this.eventBus.on(g.DIALOG_HIDE,(e=>{var t,{name:i,reason:o}=e;m.info("[DialogQueue]",'Dialog "'.concat(i,'" is hidden'));var n=null===(t=this.dialogCenter)||void 0===t?void 0:t.dialogs.get(i);n&&(n._status.CLOSED=!0,n._status.REASON=o)}))}add(e){var{name:t}=e;if(!this.dialogCenter||this.dialogCenter.getDialog(t)){var i=this.queue.findIndex((e=>e.name===t)),o=this.currentDialog&&this.currentDialog.name===t,n=this.nextDialog&&this.nextDialog.name===t;if(o||n||-1!==i){if(o||n)return void m.info("[DialogQueue]",'Dialog "'.concat(t,'" is currently showing or prepared, ignoring add.'));if(!(e.priority<this.queue[i].priority))return void m.info("[DialogQueue]",'Dialog "'.concat(t,'" already in queue with same or lower priority, ignoring add.'));var r=this.queue[i];this.queue[i]=e,e._status.WAITING=!0,r._status.SKIPPED=!0,r._status.REASON="replaced-by-higher-priority",this.eventBus.emit(g.DIALOG_SKIPPED,{name:r.name,reason:"replaced-by-higher-priority"}),m.info("[DialogQueue]",'Dialog "'.concat(t,'" updated in queue with higher priority, replacing previous one.')),this._sortQueue()}else this.queue.push(e),e._status.WAITING=!0,m.info("[DialogQueue]",'Dialog "'.concat(t,'" added to queue with priority ').concat(e.priority)),this._sortQueue();var a=e._compatMode||!1;if(!this.isStarted&&this.hasEverStarted)return m.info("[DialogQueue]","Queue stopped, auto-restarting for new dialog"),void this.start("single");this.waitingTimeoutId?(m.info("[DialogQueue]","New dialog arrived during waiting period, processing immediately"),this._clearWaitingTimeout(),this.currentDialog||this.isProcessing||this.isPreparing||setTimeout((()=>this._showNextOrPrepare()),10)):this.currentDialog||this.isProcessing||this.isPreparing?!this.currentDialog||this.nextDialog||this.isPreparing||setTimeout((()=>this._prepareNext()),10):setTimeout((()=>this._showNextOrPrepare()),10),this.eventBus.emit(g.QUEUE_UPDATED,{queue:this.queue.map((e=>e.name)),added:t,name:t,isCompatMode:a})}else m.error("[DialogQueue]",'Dialog "'.concat(t,'" not registered'))}remove(e){var t=Array.isArray(e)?e:[e];if(0===t.length||t.some((e=>!e)))return m.error("[DialogQueue]","Invalid input: names array cannot be empty or contain empty strings"),!1;var i=new Set(t),o=!1,n=[],r=this.queue.length;return this.queue=this.queue.filter((e=>!i.has(e.name)||(m.info("[DialogQueue]",'Removing dialog "'.concat(e.name,'" from queue.')),n.push(e),!1))),this.queue.length<r&&(o=!0),this.nextDialog&&i.has(this.nextDialog.name)&&(m.info("[DialogQueue]",'Removing prepared dialog "'.concat(this.nextDialog.name,'".')),n.push(this.nextDialog),this.nextDialog=null,o=!0,this.currentDialog&&!this.isPreparing&&setTimeout((()=>this._prepareNext()),10)),n.forEach((e=>{e._status.SKIPPED=!0,e._status.REASON="removed",this.eventBus.emit(g.DIALOG_SKIPPED,{name:e.name,reason:"removed"})})),o&&m.info("[DialogQueue]","Successfully removed dialogs matching: ".concat(t.join(", ")," from queue/prepared state.")),o}setBeforeShowFilter(e){this._beforeShowFilter=e,m.info("[DialogQueue]: BeforeShowFilter set successfully")}_executeBeforeShowBFFFilter(e){var t=this;return u((function*(){if(!t._beforeShowFilter)return!0;if(e._status._BFF_CHECKED){var i=!e._status.SKIPPED||"bff 过滤"!==e._status.REASON;return m.info("[DialogQueue] BFF过滤已检查过: ".concat(e.name,", 结果: ").concat(i)),i}if(!e||!e.name)return m.error("[DialogQueue] BFF过滤函数参数校验失败: dialog参数无效"),!0;try{m.info("[DialogQueue] 执行外部BFF过滤函数: ".concat(e.name));var o=t.getAllDialogsInQueue(),n=yield Promise.resolve(t._beforeShowFilter({allDialogs:o,currentDialog:e})),{shouldShow:r=!0,reason:a="",details:s={}}=n;return e._status._BFF_CHECKED=!0,e._status._BFF_DETAILS=s,r||(m.info("[DialogQueue] BFF过滤阻止弹窗显示: ".concat(e.name,", 原因: ").concat(a)),t.eventBus.emit(g.BFF_FILTER_APPLIED,{name:e.name,reason:a,details:s})),Boolean(r)}catch(i){return m.error("[DialogQueue] BFF过滤检查失败: ".concat(e.name),i),e._status._BFF_CHECKED=!0,t.eventBus.emit(g.BFF_FILTER_ERROR,{name:e.name,error:i instanceof Error?i.message:String(i)}),!0}}))()}start(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"single";this.isStarted||(m.info("[DialogQueue]","Queue starting with type: ".concat(e)),this.isStarted=!0,this.hasEverStarted=!0,this.startType=e,this.eventBus.emit(g.QUEUE_STARTED,{type:e,StartTime:Date.now()}),setTimeout((()=>this._showNextOrPrepare()),50))}hide(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"user-dismissed";if(e&&this.currentDialog&&this.currentDialog.name===e||!e&&this.currentDialog){var i=this.currentDialog,o=i.name,n=i;m.info("[DialogQueue]",e?'Hiding specific current dialog "'.concat(o,'" (Reason: ').concat(t,")"):'Hiding current dialog "'.concat(o,'" (Reason: ').concat(t,")")),this.eventBus.emit(g.DIALOG_HIDE,{name:o,dialog:n,reason:t}),this.currentDialog=null,this.isProcessing=!1,this.eventBus.emit(g.DIALOG_HIDDEN,{name:o,reason:t}),this.isStarted&&setTimeout((()=>this._showNextOrPrepare()),10)}else e&&this.remove(e)}_clearWaitingTimeout(){this.waitingTimeoutId&&(clearTimeout(this.waitingTimeoutId),this.waitingTimeoutId=null,m.info("[DialogQueue]","Waiting timeout cleared"))}_setupWaitingTimeout(){this._clearWaitingTimeout(),m.info("[DialogQueue]","Setting up waiting timeout for ".concat(this.waitDelay,"ms")),this.waitingTimeoutId=setTimeout((()=>{m.info("[DialogQueue]","Waiting period ended with no new dialogs"),this.waitingTimeoutId=null,0!==this.queue.length||this.currentDialog||this.nextDialog||(m.info("[DialogQueue]","Queue is completely empty, stopping queue (type: ".concat(this.startType,")")),this.isStarted=!1,this.eventBus.emit(g.QUEUE_EMPTY,{type:this.startType}))}),this.waitDelay)}_showNextOrPrepare(){if(!this.currentDialog&&!this.isProcessing){if(this.nextDialog){if(this.queue.length>0&&this.queue[0].priority<this.nextDialog.priority)return m.warn("[DialogQueue]",'Higher priority dialog "'.concat(this.queue[0].name,'" (').concat(this.queue[0].priority,') found in queue. Postponing prepared dialog "').concat(this.nextDialog.name,'" (').concat(this.nextDialog.priority,").")),void this._processQueue();m.info("[DialogQueue]",'Showing prepared dialog "'.concat(this.nextDialog.name,'"'));var e=this.nextDialog;return this.nextDialog=null,void this._showDialog(e)}m.info("[DialogQueue]","_showNextOrPrepare: No prepared dialog, calling _processQueue."),this._processQueue()}}_processQueue(){if(!this.isProcessing&&this.isStarted&&!this.currentDialog&&!this.isPreparing)if(0!==this.queue.length){this._clearWaitingTimeout(),this.isProcessing=!0;var e=this.queue.shift();this._processingDialog=e,m.info("[DialogQueue]",'Processing dialog "'.concat(e.name,'" from queue for display.')),this.eventBus.emit(g.QUEUE_ADVANCED,{name:e.name,remaining:this.queue.length}),this._executeBeforeShowBFFFilter(e).then((t=>(m.info('[DialogQueue] BFF filter result for "'.concat(e.name,'": ').concat(t)),t?(m.info('[DialogQueue] Executing onBeforeShow for "'.concat(e.name,'"')),Promise.resolve(e&&e.onBeforeShow?e.onBeforeShow(e):null)):(e._status.SKIPPED=!0,e._status.REASON="bff 过滤",this.isProcessing=!1,this._processingDialog=null,m.info('[DialogQueue] Dialog "'.concat(e.name,'" skipped by BFF filter, processing next')),setTimeout((()=>this._showNextOrPrepare()),10),Promise.reject(Symbol("BFF_FILTER_REJECTED")))))).then((t=>{m.info('[DialogQueue] onBeforeShow result for "'.concat(e.name,'":'),t),this._processingDialog=null,this.checkBeforeShowStatus(e,t,!1)})).catch((t=>{"symbol"==typeof t&&"Symbol(BFF_FILTER_REJECTED)"===t.toString()||(this._processingDialog=null,m.error('[DialogQueue] Error in onBeforeShow hook for "'.concat(e.name,'":'),t),this._handleDialogError(e,t,!1))}))}else this.waitingTimeoutId||(m.info("[DialogQueue]","Queue is empty, waiting for new dialogs"),this._setupWaitingTimeout())}_prepareNext(){if(this.isStarted&&this.currentDialog&&!this.nextDialog&&!this.isPreparing&&0!==this.queue.length){this.isPreparing=!0;var e=this.queue[0];m.info("[DialogQueue]",'Attempting to prepare next dialog "'.concat(e.name,'"')),e._status._PREPARING=!0,this._executeBeforeShowBFFFilter(e).then((t=>t?Promise.resolve(e.onBeforeShow?e.onBeforeShow(e):null):(e._status._PREPARING=!1,e._status.SKIPPED=!0,e._status.REASON="bff 过滤",this.isPreparing=!1,setTimeout((()=>this._showNextOrPrepare()),10),Promise.reject(Symbol("BFF_FILTER_REJECTED"))))).then((t=>{e._status._PREPARING=!1,this.checkBeforeShowStatus(e,t,!0)})).catch((t=>{"symbol"==typeof t&&"Symbol(BFF_FILTER_REJECTED)"===t.toString()||(e._status._PREPARING=!1,m.error("[DialogQueue]",'Error _PREPARING dialog "'.concat(e.name,'":'),t),this._handleDialogError(e,t,!0))}))}}_showDialog(e){this.currentDialog=e,this.isProcessing=!0,m.info("[DialogQueue]",'Showing dialog "'.concat(e.name,'"')),e._status._RENDERING=!0,this.eventBus.emit(g.DIALOG_BEFORE_SHOW,{name:e.name}),this._renderDialog(e)}_renderDialog(e){"autoMount"===e._renderType&&e.importFn?this.eventBus.emit(g.RENDER_AUTO_MOUNT,{dialog:e,onSuccess:()=>this._handleDialogShown(e),onError:t=>this._handleDialogError(e,t,!1)}):"standard"===e._renderType&&(e.component||e.importFn)?this.eventBus.emit(g.RENDER_STANDARD,{dialog:e,onSuccess:()=>this._handleDialogShown(e),onError:t=>this._handleDialogError(e,t,!1)}):(m.error("[DialogQueue]",'Invalid dialog configuration for "'.concat(e.name,'"')),this._handleDialogError(e,new Error("Invalid dialog configuration"),!1))}_handleDialogShown(e){this.currentDialog&&this.currentDialog.name===e.name?(e._status._RENDERING=!1,e._status.SHOWING=!0,setTimeout((()=>{try{e&&e.onAfterShow&&e.onAfterShow(e)}catch(t){a.error('Error in onAfterShow hook for "'.concat(e.name,'":'),t)}})),this.eventBus.emit(g.DIALOG_SHOWN,{name:e.name,timestamp:Date.now()}),e.displayOptions&&e.displayOptions.timeout>0&&setTimeout((()=>{this.currentDialog&&this.currentDialog.name===e.name&&this.hide(e.name,"timeout")}),e.displayOptions.timeout),setTimeout((()=>this._prepareNext()),10)):m.warn("[DialogQueue]",'_handleDialogShown called for dialog "'.concat(e.name,"\" but it's not the current one."))}_handleDialogError(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];a.error("Error ".concat(i?"_PREPARING":"showing",' dialog "').concat(e.name,'":'),t),e._status.ERROR=!0,e._status.SKIPPED=!0,e._status.REASON=t.message||"Unknown error",e._status._RENDERING=!1,e._status._PREPARING=!1,this.eventBus.emit(g.DIALOG_ERROR,{name:e.name,error:t,errorMsg:"弹窗渲染报错"}),i?(this.queue[0]&&this.queue[0].name===e.name&&this.queue.shift(),this.isPreparing=!1,this.currentDialog?setTimeout((()=>this._prepareNext()),10):this.queue.length>0&&setTimeout((()=>this._showNextOrPrepare()),10)):(this.currentDialog=null,this.isProcessing=!1,setTimeout((()=>this._showNextOrPrepare()),10))}_sortQueue(){this.queue.sort(((e,t)=>e.priority-t.priority))}setWaitDelay(e){"number"==typeof e&&e>=0&&(this.waitDelay=e,m.info("[DialogQueue]","Wait delay set to ".concat(e,"ms")))}getStatus(){return{isStarted:this.isStarted,isProcessing:this.isProcessing,isPreparing:this.isPreparing,isWaiting:!!this.waitingTimeoutId,currentDialog:this.currentDialog?this.currentDialog.name:null,preparedDialog:this.nextDialog?this.nextDialog.name:null,queueLength:this.queue.length,queueItems:this.queue.map((e=>({name:e.name,priority:e.priority})))}}getAllDialogsInQueue(){var e=[];return this._processingDialog&&e.push(this._processingDialog),e.push(...this.queue),e}checkBeforeShowStatus(e,t,i){if(!1===t){var o=i?"onBeforeShow prepare 勾子函数执行失败":"onBeforeShow 勾子函数执行失败";return m.info("[DialogQueue]",'Dialog "'.concat(e.name,'" was prevented from ').concat(i?"_PREPARING":"showing"," by onBeforeShow hook")),e._status.SKIPPED=!0,e._status.REASON=o,this.eventBus.emit(g.DIALOG_SKIPPED,{name:e.name,reason:o}),void(i?(this.queue[0]&&this.queue[0].name===e.name&&this.queue.shift(),this.isPreparing=!1,this.currentDialog?setTimeout((()=>this._prepareNext()),10):this.queue.length>0&&setTimeout((()=>this._showNextOrPrepare()),10)):(this.currentDialog=null,this.isProcessing=!1,setTimeout((()=>this._showNextOrPrepare()),10)))}i?(this.queue[0]&&this.queue[0].name===e.name&&(this.nextDialog=this.queue.shift(),this.nextDialog._status._PREPARED=!0,m.info("[DialogQueue]",'Dialog "'.concat(e.name,'" prepared successfully.'))),this.isPreparing=!1,this.currentDialog||this.isProcessing||!this.nextDialog||setTimeout((()=>this._showNextOrPrepare()),10)):this._showDialog(e)}}var y=(e=>(e.RENDER_AUTO_MOUNT="render:autoMount",e.RENDER_STANDARD="render:standard",e.DIALOG_HIDE="dialog:hide",e.DIALOG_HIDDEN="dialog:hidden",e.DIALOG_BEFORE_SHOW="dialog:beforeShow",e.DIALOG_SHOWN="dialog:shown",e.DIALOG_ERROR="dialog:error",e.DIALOG_REGISTERED="dialog:registered",e.DIALOG_SKIPPED="dialog:skipped",e.DIALOG_INITIALIZED="dialog:initialized",e.QUEUE_STARTED="queue:started",e.QUEUE_UPDATED="queue:updated",e.QUEUE_ADVANCED="queue:advanced",e.QUEUE_EMPTY="queue:empty",e.PRIORITY_CHANGED="priority:changed",e.REGISTRATION_COMPLETE="registration:complete",e))(y||{});class E{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;h(this,"eventBus",void 0),h(this,"activeInstances",new Map),h(this,"renderCheckTimeout",3e3),h(this,"currentDialogName",null),h(this,"globalVarName",void 0),this.eventBus=e,this.globalVarName=t||"__POPUP_SDK__",this._setupEventListeners()}_setupEventListeners(){this.eventBus.on(y.RENDER_AUTO_MOUNT,(e=>{var{dialog:t,onSuccess:i,onError:o}=e;this.currentDialogName=t.name,this._renderAutoMount(t,i,o)})),this.eventBus.on(y.RENDER_STANDARD,(e=>{var{dialog:t,onSuccess:i,onError:o}=e;this.currentDialogName=t.name,this._renderStandard(t,i,o)})),this.eventBus.on(y.DIALOG_HIDE,(e=>{var{name:t,dialog:i}=e;this.currentDialogName===t&&(this.currentDialogName=null),i&&i.keepAlive||this._unmountDialog(t)}))}_checkRenderResult(e,t,i){var o,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],{name:r}=e,a=(null===(o=e.displayOptions)||void 0===o?void 0:o.renderCheckTimeout)||this.renderCheckTimeout;setTimeout((()=>{if(this.currentDialogName===r)try{if(!t&&n.length>0){for(var e of(m.info('[DialogRenderer]: Retrying to find container for "'.concat(r,'"')),n)){var o=document.querySelector(e);if(o){t=o,m.info("[DialogRenderer]: Found delayed container with selector: ".concat(e));break}}if(!t)throw new Error("未找到容器元素。尝试的选择器: ".concat(n.join(", ")))}if(!t)throw new Error("弹窗容器未找到");if(!document.body.contains(t))throw new Error("弹窗容器不在文档中");if(!t.children.length)throw new Error("弹窗没有内容");var a=window.getComputedStyle(t.children[0]);if(!("none"!==a.display&&"hidden"!==a.visibility&&"0"!==a.opacity))throw new Error("弹窗不可见");m.info('[DialogRenderer]: Dialog "'.concat(r,'" successfully rendered'))}catch(e){var s=e instanceof Error?e.message:"Unknown render error";m.error('[DialogRenderer]: Dialog "'.concat(r,'" 渲染失败: ').concat(s)),i(new Error("渲染失败: ".concat(s))),this._unmountDialog(r)}else m.info('[DialogRenderer]: Skip render check for "'.concat(r,"\", it's no longer the current dialog"))}),a)}_renderAutoMount(e,t,i){var{name:o,importFn:n,displayOptions:r,containerId:a=""}=e;try{var s=(null==r?void 0:r.delay)||0,u=()=>{try{var o=null,n=[];if(Array.isArray(a))for(var r of(n=a,a)){var s=document.querySelector(r);if(s){o=s;break}}else a&&(n=[a],o=document.querySelector(a));t(),this._checkRenderResult(e,o,i,n)}catch(e){i(e instanceof Error?e:new Error(String(e)))}};setTimeout((()=>{n?n().then((e=>{var t="function"==typeof e.default?e.default:e;this.activeInstances.set(o||"",{cleanup:t}),u()})).catch((e=>{i(e)})):i(new Error('Import function not provided for dialog "'.concat(o,'"')))}),s)}catch(e){i(e instanceof Error?e:new Error(String(e)))}}_renderStandard(e,t,i){var{name:n,component:r,importFn:a,props:s,displayOptions:u}=e,l=(null==u?void 0:u.delay)||0,h=r=>{try{var a=document.createElement("div");a.className="popup-dialog popup-dialog-".concat(n),document.body.appendChild(a);var u=c(c({},s),{},{onClose:(e,t)=>{window&&window[this.globalVarName]&&window[this.globalVarName].hide(e,t)}}),l=(0,o.createApp)({render:()=>(0,o.h)(r,u||{})});l.mount(a),this.activeInstances.set(n||"",{app:l,container:a}),t(),this._checkRenderResult(e,a,i)}catch(e){i(e instanceof Error?e:new Error(String(e)))}};setTimeout((()=>{if(r)if("function"!=typeof r||"render"in r||"setup"in r||"template"in r)h(r);else try{var e=r();e&&"function"==typeof e.then?e.then((e=>{h(e.default||e)})).catch((e=>{i(e)})):h(e.default||e)}catch(e){i(e instanceof Error?e:new Error(String(e)))}else a?a().then((e=>{var t=e.default||e;h(t)})).catch((e=>{i(e)})):i(new Error('No valid component or importFn for dialog "'.concat(n,'"')))}),l)}_unmountDialog(e){var t=this.activeInstances.get(e);if(t){try{t.cleanup&&"function"==typeof t.cleanup?t.cleanup():t.app&&(t.app.unmount(),t.container&&t.container.parentNode&&t.container.parentNode.removeChild(t.container))}catch(t){a.error('Error unmounting dialog "'.concat(e,'":'),t)}this.activeInstances.delete(e)}}}var w=n.h.SIMetric,S={enabled:!0,bizModule:"global-popup-sdk",allowSensitiveInfo:!1,device_type:"pwa",server_type:"central",brand:"shein",language:"en",currency:"USD",env:"",site_uid:""},I={maxSize:1,flushInterval:1e4,flushOnUnload:!0};class b{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};h(this,"config",void 0),h(this,"queueConfig",void 0),h(this,"eventBus",void 0),h(this,"isInitialized",!1),h(this,"eventQueue",[]),h(this,"flushTimer",null),h(this,"lastFlushTime",0),h(this,"isFlushing",!1),this.config=c(c({},S),t),this.queueConfig=c(c({},I),t.queueConfig||{}),this.eventBus=e,this.init()}init(){this.config.enabled?(this.ensureSILogInitialized(),this.setupEventListeners(),this.startFlushInterval(),this.queueConfig.flushOnUnload&&"undefined"!=typeof window&&window.addEventListener("beforeunload",(()=>{this.flush(!0)})),this.isInitialized=!0,m.info("[Monitor] Initialized with config:",this.config),m.info("[Monitor] Queue config:",this.queueConfig)):m.info("[Monitor] Monitoring is disabled")}ensureSILogInitialized(){try{"undefined"!=typeof window&&(m.warn("[Monitor] SILog is not initialized, trying to initialize it"),n.h.init({device_type:this.config.device_type,server_type:this.config.server_type,brand:this.config.brand||"shein",language:this.config.language||"en",currency:this.config.currency||"USD",env:this.config.env,site_uid:this.config.site_uid}))}catch(e){m.error("[Monitor] Failed to initialize SILog:",e)}}setupEventListeners(){this.eventBus.on(g.DIALOG_REGISTERED,(e=>{var{name:t,options:i}=e;this.trackEvent("popup_register",{name:t,region:i.region,priority:i.priority,renderType:i._renderType,track_type:"1"})})),this.eventBus.on(g.QUEUE_UPDATED,(e=>{var{name:t}=e;this.trackEvent("popup_queue_update",{name:t,track_type:"2"})})),this.eventBus.on(g.DIALOG_SHOWN,(e=>{var{name:t}=e;this.trackEvent("popup_show",{name:t,track_type:"3"})})),this.eventBus.on(g.DIALOG_HIDE,(e=>{var{name:t,result:i}=e;this.trackEvent("popup_hide",{name:t,reason:"string"==typeof i?i:"user_action",hasResult:void 0!==i,track_type:"4"})})),this.eventBus.on(g.DIALOG_ERROR,(e=>{var{name:t,error:i}=e;this.trackEvent("popup_error",{name:t,errorType:i.name||"Error",errorMessage:this.sanitizeErrorMessage(i.message)||"Unknown error",track_type:"5"})})),this.eventBus.on(g.DIALOG_SKIPPED,(e=>{var{name:t,reason:i}=e;this.trackEvent("popup_skip",{name:t,reason:i||"condition_not_met",track_type:"6"})})),this.eventBus.on(g.QUEUE_EMPTY,(()=>{this.trackEvent("popup_queue_empty")})),m.info("[Monitor] Event listeners setup complete")}sanitizeErrorMessage(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!e||this.config.allowSensitiveInfo)return e;var t=e;return[{regex:/token[=:]\s*([^&\s]+)/gi,replace:"token=***"},{regex:/password[=:]\s*([^&\s]+)/gi,replace:"password=***"},{regex:/key[=:]\s*([^&\s]+)/gi,replace:"key=***"},{regex:/secret[=:]\s*([^&\s]+)/gi,replace:"secret=***"},{regex:/authorization[=:]\s*([^&\s]+)/gi,replace:"authorization=***"}].forEach((e=>{t=t.replace(e.regex,e.replace)})),t}getBaseProperties(){var e={isSpider:"undefined"==typeof window?"unknown":(0,r.s)()};return this.config.customTags&&Object.entries(this.config.customTags).forEach((t=>{var[i,o]=t;e[i]=o})),e}startFlushInterval(){null!==this.flushTimer&&clearInterval(this.flushTimer),this.flushTimer=window.setInterval((()=>{this.flush()}),this.queueConfig.flushInterval),m.debug("[Monitor] Flush interval started:",this.queueConfig.flushInterval)}addToQueue(e){this.eventQueue.push(e),this.eventQueue.length>=this.queueConfig.maxSize&&this.flush()}flush(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(0!==this.eventQueue.length&&(!this.isFlushing||e)){var t=Date.now();if(!e&&t-this.lastFlushTime<1e3)m.debug("[Monitor] Flush rate limited, skipping");else{this.isFlushing=!0,this.lastFlushTime=t;var i=[...this.eventQueue];this.eventQueue=[],m.debug("[Monitor] Flushing ".concat(i.length," events"));var o=i.filter((e=>"count"===e.type)),n=i.filter((e=>"time"===e.type));if(o.length>0)try{o.forEach((e=>{null==w||w.metricCount(e.data)})),m.debug("[Monitor] Reported ".concat(o.length," count events"))}catch(e){m.error("[Monitor] Failed to report count events:",e),this.eventQueue.push(...o)}if(n.length>0)try{n.forEach((e=>{null==w||w.metricTime(e.data,e.options)})),m.debug("[Monitor] Reported ".concat(n.length," time events"))}catch(e){m.error("[Monitor] Failed to report time events:",e),this.eventQueue.push(...n)}this.isFlushing=!1}}}trackEvent(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.config.enabled){var i=this.config.bizModule||"global_popup_sdk";try{var o=c(c({},this.getBaseProperties()),t),n={metric_name:i,tags:c(c({},o),{},{event_type:e,alert_type:t.name}),message:"Popup SDK Event: ".concat(e),params:this.config.params||{}};this.addToQueue({type:"count",data:n,timestamp:Date.now()}),m.debug("[Monitor] Event queued:",e)}catch(e){m.error("[Monitor] Failed to track event:",e)}}}trackPerformance(e,t,i){if(this.config.enabled)try{var o={metric_name:"popup_performance",tags:c(c({},this.getBaseProperties()),{},{dialog_name:e.name,stage:t}),value:i,message:"Popup Performance: ".concat(e.name," - ").concat(t)};this.addToQueue({type:"time",data:o,timestamp:Date.now(),options:{random:.05}}),m.debug("[Monitor] Performance metric queued:",e.name,t,i)}catch(e){m.error("[Monitor] Failed to track performance:",e)}}updateConfig(e){var t,i=this.config;(this.config=c(c({},this.config),e),e.queueConfig)&&(this.queueConfig=c(c({},this.queueConfig),e.queueConfig),e.queueConfig.flushInterval&&e.queueConfig.flushInterval!==(null===(t=i.queueConfig)||void 0===t?void 0:t.flushInterval)&&this.startFlushInterval());m.info("[Monitor] Configuration updated:",e)}getStatus(){return{enabled:this.config.enabled,isInitialized:this.isInitialized,bizModule:this.config.bizModule,queueSize:this.eventQueue.length,queueConfig:c({},this.queueConfig),lastFlushTime:this.lastFlushTime,isFlushing:this.isFlushing}}forceFlush(){this.flush(!0)}}var P=new class{constructor(){h(this,"handlers",void 0),this.handlers=new Map}on(e,t){this.handlers.has(e)||this.handlers.set(e,new Set);var i=this.handlers.get(e);i&&i.add(t)}off(e,t){if(this.handlers.has(e)){var i=this.handlers.get(e);i&&(t?(i.delete(t),0===i.size&&this.handlers.delete(e)):this.handlers.delete(e))}}emit(e,t){if(this.handlers.has(e)){var i=this.handlers.get(e);if(i)Array.from(i).forEach((i=>{try{i(t)}catch(t){a.error('Error in event handler for "'.concat(e,'":'),t)}}))}}getHandlers(e){var t=this.handlers.get(e);return t?Array.from(t):[]}hasListeners(e){var t=this.handlers.get(e);return!!t&&t.size>0}clear(){this.handlers.clear()}once(e,t){var i=o=>{this.off(e,i),t(o)};this.on(e,i)}getEventNames(){return Array.from(this.handlers.keys())}},R="1.6.1";function C(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t={enableCompat:!1,enableMonitor:!0,monitorConfig:{},globalVarName:"__POPUP_SDK__",globalContext:{}},i=c(c(c({},t),e),{},{monitorConfig:c(c({},t.monitorConfig||{}),e.monitorConfig||{}),globalContext:c(c({},t.globalContext||{}),e.globalContext||{})}),o=i.enableMonitor?new b(P,i.monitorConfig):null;i.enableMonitor||a.info("[PopupSDK] Monitor is disabled by configuration");var n=new _(P),r=new D(P,n,null==i?void 0:i.globalContext),s=new E(P,null==i?void 0:i.globalVarName);n.dialogCenter=r;var l=!1,h=!1,p=new Set,f={setupCompatibility(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return l?(a.warn("[PopupSDK] Cannot setup compatibility layer after registration is complete"),this):(c({enabled:!1},e).enabled&&!h&&(a.info("[PopupSDK] Enabling compatibility layer"),function(e,t){if(window._GB_PopUpModalEventCenter_)return a.warn("[PopupSDK] Legacy compatibility layer already initialized, please check your code"),window._GB_PopUpModalEventCenter_;m.info("[Legacy]","Setting up compatibility layer");var i=["forceUpdatePwd","marketing","ip","mutiplePartPrivacy","mutipleLang","guideInstall","coupon","couponRevisit","quickRegister","onetrust","sheinPush","message"],o=i.reduce(((e,t)=>(e[t]={loading:!0,isWait:!1},e)),{}),n=new Map,r="";function s(e){if(n.has(e)){var t=n.get(e)||[];m.info("[Legacy]","Executing ".concat(t.length,' callbacks for dialog "').concat(e,'"')),t.forEach((t=>{try{"function"==typeof t&&t()}catch(t){a.error('[Legacy] Error executing callback for "'.concat(e,'":'),t)}}))}}var l={on:t.on.bind(t),off:t.off.bind(t),emit:t.emit.bind(t),globPopupModalInfo:o,globPopupModalSort:i,pushQueue(t,l){if(t){m.info("[Legacy]","pushQueue called for: ".concat(t));try{if(o[t]={loading:!1,isWait:!0},n.has(t)||n.set(t,[]),"function"==typeof l&&n.has(t)){var h=n.get(t);h&&h.push(l)}if(!(e&&e._components&&e._components.center&&e._components.queue))return void m.error("[Legacy]","SDK components not available, cannot add dialog to queue");var g=e._components.center.getDialog?e._components.center.getDialog(t):e._components.center.dialogs?e._components.center.dialogs.get(t):void 0;if(g){m.info("[Legacy]",'Dialog "'.concat(t,'" found in registry, activating'));var p=i.indexOf(t)>=0?10*(i.length-i.indexOf(t)):100;e._components.queue.add({name:t,component:g.component,importFn:g.importFn,priority:g.priority||p,displayOptions:g.displayOptions||{},containerId:g.containerId||"",props:g.props||{},onBeforeShow:(D=u((function*(){if(g.onBeforeShow)try{yield g.onBeforeShow(g)}catch(e){a.error('[Legacy] Error in onBeforeShow hook for "'.concat(t,'":'),e)}})),function(){return D.apply(this,arguments)}),onAfterShow:(v=u((function*(e){if(g.onAfterShow)try{yield g.onAfterShow(e)}catch(e){a.error('[Legacy] Error in onAfterShow hook for "'.concat(t,'":'),e)}s(t),r=t})),function(e){return v.apply(this,arguments)}),_renderType:g._renderType||"autoMount",_status:g._status||{},_compatMode:!0})}else{a.warn('[Legacy] Dialog "'.concat(t,'" not found in registry, will try to auto-register'));var f={name:t,component:void 0,importFn:()=>Promise.resolve({default:{name:"legacy-".concat(t),render:()=>null}}),priority:i.indexOf(t)>=0?10*(i.length-i.indexOf(t)):100,_renderType:"autoMount",_status:c({},d),_compatMode:!0,onAfterShow:()=>{s(t),r=t}};try{"function"==typeof e._components.center.register&&e._components.center.register(t,f.importFn,c({},f)),e._components.queue.add(f)}catch(e){a.error('[Legacy] Failed to register dummy dialog for "'.concat(t,'":'),e)}}}catch(e){a.error('[Legacy] Error in pushQueue for "'.concat(t,'":'),e)}var v,D}},next(t){m.info("[Legacy]","next called for: ".concat(t));try{t&&o[t]&&(o[t].isWait=!1),e&&"function"==typeof e.hide&&(m.info("[Legacy]","Hiding current dialog with sdk.hide()"),e.hide(t,"legacy-next-called")),this.lastPopupModalName=t||r}catch(e){a.error("[Legacy] Error in next method:",e)}},done(e){if(m.info("[Legacy]","done called for: ".concat(e)),i.includes(e))try{o[e]&&(o[e].loading=!1,o[e].isWait=!0),this.clearCallbacks(e)}catch(t){a.error('[Legacy] Error in done method for "'.concat(e,'":'),t)}},init(){m.info("[Legacy]","init called");try{e&&"function"==typeof e.start&&e.start("single")}catch(e){a.error("[Legacy] Error in init method:",e)}},getCallbacks:e=>n.get(e)||[],clearCallbacks(e){n.delete(e)},_initialized:!0};window._GB_PopUpModalEventCenter_=l;try{t.on(g.DIALOG_HIDDEN,(e=>{try{var t=null==e?void 0:e.name;if(!t)return;m.info("[Legacy]","Dialog hidden event received: ".concat(t)),o[t]&&(o[t].isWait=!1)}catch(e){a.error("[Legacy] Error handling dialog hidden event:",e)}}))}catch(e){a.error("[Legacy] Error setting up event listeners:",e)}a.log("[Legacy] Compatibility layer initialized successfully")}(this,P),h=!0),this)},register(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.register(e,t,i),i.watchRouter&&p.add(e),this},registerAutoMount(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.registerAutoMount(e,t,i),this},completeRegistration(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(l)return this;var i={waitForQuene:!1,quenelWaitTime:800};if("boolean"==typeof t?i.waitForQuene=t:"object"==typeof t&&Object.assign(i,t),l=!0,i.beforeShowFilter&&n.setBeforeShowFilter(i.beforeShowFilter),P.emit(g.REGISTRATION_COMPLETE),a.info("%c Global Popup SDK %c v".concat(R," %c"),"background:#35495e; padding: 1px; border-radius: 3px 0 0 3px; color: #fff;","background:#41b883; padding: 1px; border-radius: 0 3px 3px 0; color: #fff;","background:transparent"),e){var o=null,r=e=>{var{isTimedout:t=!1}=e;m.info("[PopupSDK] Conditions checked ".concat(t?"(timed out)":"",", starting queue processing")),m.info("[PopupSDK] Starting queue immediately after condition checks"),n.start("global"),o&&(clearTimeout(o),m.info("[PopupSDK] Timeout cleared since queue already started"),o=null),P.off(g.CONDITIONS_CHECKED,r)};P.on(g.CONDITIONS_CHECKED,r),o=setTimeout((()=>{m.info("[PopupSDK] Conditions checked timeout after ".concat(i.quenelWaitTime,"ms, starting queue")),n.start("global"),P.off(g.CONDITIONS_CHECKED,r),o=null}),i.quenelWaitTime)}else m.warn("[PopupSDK] Registration complete, autoStart is disabled");return this},start(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"single";return n.start(e),this},hide(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"api-call";return n.hide(e,t),this},getDialog:e=>r.getDialog(e),getQueueStatus:()=>n.getStatus(),getAllDialogsInQueue:()=>n.getAllDialogsInQueue(),exists:e=>r.exists(e),addToQueueByRegion:(e,t,i)=>r.addDialogsToQueneByRegion(e,t,i),getDialogsStatus:e=>r.getAllDialogs(e),getMonitorStatus:()=>o?o.getStatus():(a.warn("[PopupSDK] Monitor is disabled, cannot get status"),null),updateMonitorConfig(e){o?o.updateConfig(e):a.warn("[PopupSDK] Monitor is disabled, cannot update config")},trackEvent(e,t){o?o.trackEvent(e,t):a.warn("[PopupSDK] Monitor is disabled, cannot track event")},removeFromQueue:e=>n.remove?n.remove(e):(a.warn("[PopupSDK] remove method not implemented in queue"),!1),setRouter(e){if(!e||"object"!=typeof e)return a.warn("[PopupSDK] Invalid router instance"),this;try{e.afterEach(((e,t,i)=>{if(i&&a.warn("[PopupSDK] Router navigation failed:",i),e.path!==t.path){a.log("[PopupSDK] Route changed: ".concat(t.path," -> ").concat(e.path));var o=Array.from(p);o.length>0&&(a.log("[PopupSDK] Rechecking ".concat(o.length," dialogs for route change")),r.recheckConditions(o))}})),a.log("[PopupSDK] Router listener setup complete")}catch(e){a.error("[PopupSDK] Failed to setup router listener:",e)}return this},onEvent(e,t){return P.on(e,t),this},_components:{center:r,queue:n,renderer:s}};return i.enableCompat&&f.setupCompatibility({enabled:!0}),i.globalVarName&&"undefined"!=typeof window&&(window[i.globalVarName]=f),f}function O(){return C(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}},111588:(e,t,i)=>{"use strict";i.d(t,{Bd:()=>O,L:()=>C,Z6:()=>v,_t:()=>R,cV:()=>S,n_:()=>b,qM:()=>D,v9:()=>P});var o,n,r,a=i(275783),s=i(274061),u=i(737787),l=i(665640),c=Object.defineProperty,h=e=>{throw TypeError(e)},g=(e,t,i)=>((e,t,i)=>t in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i),d=(e,t,i)=>t.has(e)||h("Cannot "+i),p=(e,t,i)=>(d(e,t,"read from private field"),i?i.call(e):t.get(e)),f=(e,t,i)=>t.has(e)?h("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i);class m{constructor(e){this.router=e}_resolveUrl(e){return"string"==typeof e?e:e.query?`${e.path}?${(0,a.r)({queryObj:e.query})}`:e.path}_matchRoute(e,t,i){var o,n;try{return!(i||!t||!(null==(o=t.resolve(e).matched)?void 0:o.length)&&!(null==(n=t.resolve(e).route)?void 0:n.matched.length))}catch(e){return!1}}push(e,t=!1){const i=this._resolveUrl(e);this._matchRoute(i,this.router,t)?this.router.push(i):location.assign(i)}replace(e,t=!1){const i=this._resolveUrl(e);this._matchRoute(i,this.router,t)?this.router.replace(i):location.replace(i)}back(e=!1){var t;(null==(t=this.router)?void 0:t.back)&&!e?this.router.back():history.go(-1)}}class v{constructor(){g(this,"collections",{})}subscribe(e,t){this.collections[e]=t}describe(e){delete this.collections[e]}trigger(e,t){Object.values(this.collections).forEach((i=>{var o;return null==(o=null==i?void 0:i[e])?void 0:o.call(i,t)}))}}async function D(e,t){var i,o;const n=null==(o=null==(i=(await t({url:"/system/configs/multi_language",method:"POST",data:{languageKeys:Object.values(e)}})).data)?void 0:i.info)?void 0:o.result;return Object.keys(e).reduce(((t,i)=>(t[i]=(null==n?void 0:n[e[i]])||"",t)),{})}function _({languages:e={},langPackages:t,appConfigs:i,fromInitialize:o=!1,baseURL:n}){const{$schttp:r,$envs:a,$language:u}=i,l=e===u?e:(0,s.reactive)({...e}),c="undefined"!=typeof window&&!o,h="undefined"!=typeof window||!!a.requestInServer&&!o,g=Object.keys(t).reduce(((i,o)=>{if(e[o])return i;const n=t[o],r=Object.keys(n).reduce(((e,t)=>(e[t]="",e)),{});return l[o]=(0,s.reactive)(r),i.push([l[o],n]),i}),[]),d=g.map((([,e])=>Object.values(e))).flat();if(!d.length||!h)return{langPool:l};const p={};a.appLanguage&&(p.appLanguage=a.appLanguage);const f=r({url:"/system/configs/multi_language",method:"POST",headers:p,data:{languageKeys:d},baseURL:n}).then((e=>{var t,i;return null==(i=null==(t=e.data)?void 0:t.info)?void 0:i.result})).then((e=>(g.forEach((([t,i])=>{Object.keys(i).forEach((o=>{t[o]=(null==e?void 0:e[i[o]])||""}))})),l)));return c&&Object.assign(u,l),{request:f,langPool:l}}function y(e){return this.$getters.replaceCcySymbols?(0,u.X)(e):e}function E(e,t,i,o){let n="";return"undefined"!=typeof window||t.requestInServer?o||(n=`${e} is missing, checkout your initialize configs`):n=`should not run ${e} in server environment`,!n||(l.error(n,i),!1)}function w(e,t){var i,o,n,r,a;const s=null!==(i=e.baseURL)&&void 0!==i?i:t.requestInServer?"":`${t.langPath}/bff-api`;return(null==(o=(e={...e,baseURL:s,headers:{"bff-env":t.bffEnv||"",webVersion:t.webVersion||"","x-requested-with":"XMLHttpRequest",...e.headers},__fromBSLibs__:!0}).headers)?void 0:o["bff-env"])||null==(n=e.headers)||delete n["bff-env"],(null==(r=e.headers)?void 0:r.webVersion)||null==(a=e.headers)||delete a.webVersion,e}function S(e,t){return function({isAsync:i,opt:o,successCb:n,errorCb:r,completeCb:a}){i?e({...o}).then((e=>{n&&n(e)})).catch((e=>{r&&r(e)})).finally((()=>{a&&a()})):t({...o,success:e=>{n&&n(e)},error:e=>{r&&r(e)},complete:e=>{a&&a(e)}})}}o=new WeakMap,n=new WeakMap,r=new WeakMap;const I=globalThis.__LibsManager__||(globalThis.__LibsManager__=new class{constructor(){f(this,o,{}),f(this,n,{}),f(this,r,!1)}get appConfigs(){return p(this,o)}get proxyHosts(){return p(this,n)}_initializeSui(e,t){var i,n,r;(null==(i=null==t?void 0:t.version)?void 0:i.startsWith("2.7."))?(p(this,o).vueVersion=2,t.prototype.$SHEIN={lang:e.lang,siteUID:e.siteUID,appLanguage:e.appLanguage,cssRight:e.cssRight,webClient:"shein",isRomwe:!1}):(null==(n=null==t?void 0:t.version)?void 0:n.startsWith("3."))?(p(this,o).vueVersion=3,(null==(r=t.config)?void 0:r.globalProperties)&&(t.config.globalProperties.$SHEIN={mir:e.cssRight?"rtl":"ltr",brd:"sh"})):l.warn("Unexpected SuiVehicle")}_buildGetters(e){return Object.keys(e).reduce(((t,i)=>(Object.defineProperty(t,i,{get:e[i]}),t)),{})}initialize({envs:e,getters:t,languages:i,langPackages:n={},schttp:a,schttpSync:s,router:u},c){if("undefined"!=typeof window){if(p(this,r))return void l.warn("Already initialized");e.requestInServer=!1}var h,g,f,v,D;this._initializeSui(e,c),p(this,o).$envs={...e},p(this,o).$getters=this._buildGetters(t),p(this,o).$router=new m(u),p(this,o).$originSchttp=a,p(this,o).$utils=(h=p(this,o),{replaceCurrencySymbols:y.bind(h)}),p(this,o).$schttp=function(e,t){return function(i){if(!E("$schttp",t,i,e))throw new Error("_ensureEnvironment");return e(w(i,t))}}(a,e),p(this,o).$schttpSync=function(e,t){return function(i){if(!E("$schttpSync",t,i,e))throw new Error("_ensureEnvironment");return e(w(i,t))}}(s,e),p(this,o).$schttpInOne=S(p(this,o).$schttp,p(this,o).$schttpSync),p(this,o).$language=_({languages:i,langPackages:n,appConfigs:p(this,o),fromInitialize:!0}).langPool,v=!0,d(g=this,f=r,"write to private field"),D?D.call(g,v):f.set(g,v)}assignGlobalEventProxyHost(e,t){p(this,n)[e]=t}});function b(e,t){I.initialize(e,t)}function P(e,t){I.assignGlobalEventProxyHost(e,t)}function R(){return I.appConfigs}async function C({langPackages:e}){if("undefined"!=typeof window)return await _({languages:I.appConfigs.$language,langPackages:e,appConfigs:I.appConfigs}).request}function O(){return I.proxyHosts}},151324:e=>{for(var t=[],i=0;i<256;++i)t[i]=(i+256).toString(16).substr(1);e.exports=function(e,i){var o=i||0,n=t;return n[e[o++]]+n[e[o++]]+n[e[o++]]+n[e[o++]]+"-"+n[e[o++]]+n[e[o++]]+"-"+n[e[o++]]+n[e[o++]]+"-"+n[e[o++]]+n[e[o++]]+"-"+n[e[o++]]+n[e[o++]]+n[e[o++]]+n[e[o++]]+n[e[o++]]+n[e[o++]]}},310867:(e,t,i)=>{var o=i(12393),n=i(151324);e.exports=function(e,t,i){var r=t&&i||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var a=(e=e||{}).random||(e.rng||o)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t)for(var s=0;s<16;++s)t[r+s]=a[s];return t||n(a)}},386208:(e,t,i)=>{var o,n,r=i(12393),a=i(151324),s=0,u=0;e.exports=function(e,t,i){var l=t&&i||0,c=t||[],h=(e=e||{}).node||o,g=void 0!==e.clockseq?e.clockseq:n;if(null==h||null==g){var d=r();null==h&&(h=o=[1|d[0],d[1],d[2],d[3],d[4],d[5]]),null==g&&(g=n=16383&(d[6]<<8|d[7]))}var p=void 0!==e.msecs?e.msecs:(new Date).getTime(),f=void 0!==e.nsecs?e.nsecs:u+1,m=p-s+(f-u)/1e4;if(m<0&&void 0===e.clockseq&&(g=g+1&16383),(m<0||p>s)&&void 0===e.nsecs&&(f=0),f>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");s=p,u=f,n=g;var v=(1e4*(268435455&(p+=122192928e5))+f)%4294967296;c[l++]=v>>>24&255,c[l++]=v>>>16&255,c[l++]=v>>>8&255,c[l++]=255&v;var D=p/4294967296*1e4&268435455;c[l++]=D>>>8&255,c[l++]=255&D,c[l++]=D>>>24&15|16,c[l++]=D>>>16&255,c[l++]=g>>>8|128,c[l++]=255&g;for(var _=0;_<6;++_)c[l+_]=h[_];return t||a(c)}},410761:(e,t,i)=>{"use strict";function o(e){return{all:e=e||new Map,on:function(t,i){var o=e.get(t);o?o.push(i):e.set(t,[i])},off:function(t,i){var o=e.get(t);o&&(i?o.splice(o.indexOf(i)>>>0,1):e.set(t,[]))},emit:function(t,i){var o=e.get(t);o&&o.slice().map((function(e){e(i)})),(o=e.get("*"))&&o.slice().map((function(e){e(t,i)}))}}}i.d(t,{A:()=>o})},737787:(e,t,i)=>{"use strict";function o(e){if("string"!=typeof e)return"";const t={SR:"",AED:""};return e in t?t[e]:e.replace(/\b(AED|SR)(?=\s*\d+(\.\d+)?\b)/g,(e=>t[e]))}i.d(t,{X:()=>o})},834989:(e,t,i)=>{var o=i(386208),n=i(310867),r=n;r.v1=o,r.v4=n,e.exports=r},882329:(e,t,i)=>{"use strict";i.d(t,{s:()=>o});const o=({func:e,wait:t=0,options:i={}})=>{const{leading:o=!1}=i;let n,r,a;const s=function(...i){return new Promise((s=>{if(a=this,n&&clearTimeout(n),o){const o=!n;n=setTimeout((()=>{n=null}),t),o&&(r=e.apply(a,i),s(r))}else n=setTimeout((()=>{r=e.apply(a,i),s(r),n=a=null}),t)}))};return s.cancel=function(){n&&clearTimeout(n),n=a=null},s}}}]);
//# sourceMappingURL=94030-8a3086c23e808444.js.map